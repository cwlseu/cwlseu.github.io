<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CTimes+New+Roman:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.deepindeed.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":28},"copycode":false,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="软件质量是被大多数程序员挂在嘴上而不是放在心上的东西！有多少软件开发人员对正确性、健壮性、可靠性、效率、易用性、可读性（可理解性）、可扩展性、可复用性、兼容性、可移植性等质量属性了如指掌？并且能在实践中运用自如？。">
<meta property="og:type" content="article">
<meta property="og:title" content="《高质量的C++代码笔记》">
<meta property="og:url" content="http://www.deepindeed.cn/201811/20181111-hight-property-codes/index.html">
<meta property="og:site_name" content="Deepindeed">
<meta property="og:description" content="软件质量是被大多数程序员挂在嘴上而不是放在心上的东西！有多少软件开发人员对正确性、健壮性、可靠性、效率、易用性、可读性（可理解性）、可扩展性、可复用性、兼容性、可移植性等质量属性了如指掌？并且能在实践中运用自如？。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-11-11T12:59:59.000Z">
<meta property="article:modified_time" content="2022-09-02T20:05:26.052Z">
<meta property="article:author" content="CharlesCao">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="开发">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.deepindeed.cn/201811/20181111-hight-property-codes/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://www.deepindeed.cn/201811/20181111-hight-property-codes/","path":"201811/20181111-hight-property-codes/","title":"《高质量的C++代码笔记》"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>《高质量的C++代码笔记》 | Deepindeed</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-86501439-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-86501439-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>




<link rel="dns-prefetch" href="https://waline.vercel.app"><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Deepindeed</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">心有猛虎，细嗅蔷薇</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-tools"><a href="/tools/" rel="section"><i class="fa fa-globe fa-fw"></i>tools</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8E%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%9C%8B%E9%97%AE%E9%A2%98"><span class="nav-number">2.</span> <span class="nav-text">从小程序看问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">3.</span> <span class="nav-text">文件结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%A3%B0%E6%98%8E%E5%92%8C%E5%AE%9A%E4%B9%89%E5%88%86%E7%A6%BB"><span class="nav-number">3.1.</span> <span class="nav-text">为什么要声明和定义分离：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A8%8B%E5%BA%8F"><span class="nav-number">4.</span> <span class="nav-text">程序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E9%92%88%E5%A3%B0%E6%98%8E"><span class="nav-number">4.1.</span> <span class="nav-text">指针声明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%99"><span class="nav-number">5.</span> <span class="nav-text">命名规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0%E5%92%8C%E8%B5%8B%E5%80%BC%E5%87%BD%E6%95%B0"><span class="nav-number">6.</span> <span class="nav-text">类的构造函数、析构函数和赋值函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%8F%E9%AA%8C"><span class="nav-number">7.</span> <span class="nav-text">经验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E7%BB%8F%E5%85%B8"><span class="nav-number">8.</span> <span class="nav-text">调试经典</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mutable%E5%85%B3%E9%94%AE%E5%AD%97%E7%94%A8%E6%9D%A5%E8%A7%A3%E5%86%B3%E5%B8%B8%E5%87%BD%E6%95%B0%E4%B8%AD%E4%B8%8D%E8%83%BD%E4%BF%AE%E6%94%B9%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%95%B0%E6%8D%AE%E6%88%90%E5%91%98%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">9.</span> <span class="nav-text">mutable关键字用来解决常函数中不能修改对象的数据成员的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90"><span class="nav-number">10.</span> <span class="nav-text">内存对齐</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%8D%E8%A6%81%E5%9C%A8%E5%87%BD%E6%95%B0%E4%B8%AD%E5%88%9B%E5%BB%BA%E4%B8%B4%E6%97%B6%E5%AF%B9%E8%B1%A1%E8%BF%94%E5%9B%9E"><span class="nav-number">11.</span> <span class="nav-text">内存的作用域，不要在函数中创建临时对象返回</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#disable-copy%E5%92%8Cassign%E6%93%8D%E4%BD%9C%E7%9A%84%E6%96%B9%E6%B3%95-%E5%B0%86%E8%B5%8B%E5%80%BC%E5%87%BD%E6%95%B0%E5%92%8C%E6%8B%B7%E8%B4%9D%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E6%98%BE%E7%A4%BA%E4%BD%9C%E4%B8%BAprivate%E4%B8%8B"><span class="nav-number">12.</span> <span class="nav-text">Disable
COPY和ASSIGN操作的方法， 将赋值函数和拷贝构造函数显示作为private下</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#i%E5%92%8Ci%E7%9A%84%E9%87%8D%E8%BD%BD%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">13.</span> <span class="nav-text">++i和i++的重载代码实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unsigned%E7%B1%BB%E5%9E%8B%E7%9A%84%E9%BB%98%E8%AE%A4%E8%BD%AC%E5%8C%96%E9%80%A0%E6%88%90%E7%9A%84%E8%8B%A6%E6%81%BC"><span class="nav-number">14.</span> <span class="nav-text">unsigned类型的默认转化造成的苦恼</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#c%E4%B8%AD%E5%AE%B9%E6%98%93%E5%BF%BD%E7%95%A5%E7%9A%84%E5%BA%93bitset"><span class="nav-number">15.</span> <span class="nav-text">C++中容易忽略的库bitset</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%BF%E5%87%BD%E6%95%B0"><span class="nav-number">16.</span> <span class="nav-text">仿函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BF%E5%87%BD%E6%95%B0%E5%9C%A8stl%E4%B8%AD%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-number">16.1.</span> <span class="nav-text">仿函数在STL中的定义</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#google-test%E7%9A%84%E4%B8%80%E4%BA%9B%E7%96%91%E9%97%AEtest_f%E4%B8%8Etest%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">17.</span> <span class="nav-text">google
test的一些疑问：TEST_F与TEST的区别</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9C%8B%E7%9C%8Bgtest%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">18.</span> <span class="nav-text">看看gtest的工作流程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#reference"><span class="nav-number"></span> <span class="nav-text">Reference</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%9D%A5%E8%87%AAgtest%E6%96%87%E6%A1%A3%E4%B8%AD%E7%9A%84%E5%86%85%E5%AE%B9%E6%96%B9%E4%BE%BF%E5%90%8E%E7%BB%AD%E6%9F%A5%E7%9C%8B"><span class="nav-number"></span> <span class="nav-text">来自GTEST文档中的内容，方便后续查看</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#introduction-why-google-c-testing-framework"><span class="nav-number"></span> <span class="nav-text">Introduction: Why
Google C++ Testing Framework?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#setting-up-a-new-test-project"><span class="nav-number"></span> <span class="nav-text">Setting up a New Test
Project</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#basic-concepts"><span class="nav-number"></span> <span class="nav-text">Basic Concepts</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#assertions"><span class="nav-number"></span> <span class="nav-text">Assertions</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#basic-assertions"><span class="nav-number">1.</span> <span class="nav-text">Basic Assertions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#binary-comparison"><span class="nav-number">2.</span> <span class="nav-text">Binary Comparison</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#string-comparison"><span class="nav-number">3.</span> <span class="nav-text">String Comparison</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#simple-tests"><span class="nav-number"></span> <span class="nav-text">Simple Tests</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#test-fixtures-using-the-same-data-configuration-for-multiple-tests"><span class="nav-number"></span> <span class="nav-text">Test
Fixtures: Using the Same Data Configuration for Multiple Tests</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#invoking-the-tests"><span class="nav-number"></span> <span class="nav-text">Invoking the Tests</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#writing-the-main-function"><span class="nav-number"></span> <span class="nav-text">Writing the main() Function</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#important-note-for-visual-c-users"><span class="nav-number">1.</span> <span class="nav-text">Important note for Visual C++
users</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#where-to-go-from-here"><span class="nav-number"></span> <span class="nav-text">Where to Go from Here</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#known-limitations"><span class="nav-number"></span> <span class="nav-text">Known Limitations</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#more-assertions"><span class="nav-number"></span> <span class="nav-text">More Assertions</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#explicit-success-and-failure"><span class="nav-number">1.</span> <span class="nav-text">Explicit Success and Failure</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exception-assertions"><span class="nav-number">2.</span> <span class="nav-text">Exception Assertions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#predicate-assertions-for-better-error-messages"><span class="nav-number">3.</span> <span class="nav-text">Predicate
Assertions for Better Error Messages</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#using-an-existing-boolean-function"><span class="nav-number">3.1.</span> <span class="nav-text">Using an Existing Boolean
Function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#using-a-function-that-returns-an-assertionresult"><span class="nav-number">3.2.</span> <span class="nav-text">Using a
Function That Returns an AssertionResult</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#using-a-predicate-formatter"><span class="nav-number">3.3.</span> <span class="nav-text">Using a Predicate-Formatter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#floating-point-comparison"><span class="nav-number">4.</span> <span class="nav-text">Floating-Point Comparison</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#floating-point-macros"><span class="nav-number">4.1.</span> <span class="nav-text">Floating-Point Macros</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#floating-point-predicate-format-functions"><span class="nav-number">4.2.</span> <span class="nav-text">Floating-Point
Predicate-Format Functions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#windows-hresult-assertions"><span class="nav-number">5.</span> <span class="nav-text">Windows HRESULT assertions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#type-assertions"><span class="nav-number">6.</span> <span class="nav-text">Type Assertions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#assertion-placement"><span class="nav-number">7.</span> <span class="nav-text">Assertion Placement</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#teaching-google-test-how-to-print-your-values"><span class="nav-number"></span> <span class="nav-text">Teaching Google
Test How to Print Your Values</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#death-tests"><span class="nav-number"></span> <span class="nav-text">Death Tests</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-write-a-death-test"><span class="nav-number">1.</span> <span class="nav-text">How to Write a Death Test</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#regular-expression-syntax"><span class="nav-number">2.</span> <span class="nav-text">Regular Expression Syntax</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#how-it-works"><span class="nav-number">3.</span> <span class="nav-text">How It Works</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#death-tests-and-threads"><span class="nav-number">4.</span> <span class="nav-text">Death Tests And Threads</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#death-test-styles"><span class="nav-number">5.</span> <span class="nav-text">Death Test Styles</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#caveats"><span class="nav-number">6.</span> <span class="nav-text">Caveats</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#using-assertions-in-sub-routines"><span class="nav-number"></span> <span class="nav-text">Using Assertions in
Sub-routines</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#adding-traces-to-assertions"><span class="nav-number">1.</span> <span class="nav-text">Adding Traces to Assertions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#propagating-fatal-failures"><span class="nav-number">2.</span> <span class="nav-text">Propagating Fatal Failures</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#asserting-on-subroutines"><span class="nav-number">2.1.</span> <span class="nav-text">Asserting on Subroutines</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#checking-for-failures-in-the-current-test"><span class="nav-number">2.2.</span> <span class="nav-text">Checking for Failures
in the Current Test</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#logging-additional-information"><span class="nav-number"></span> <span class="nav-text">Logging Additional
Information</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#sharing-resources-between-tests-in-the-same-test-case"><span class="nav-number"></span> <span class="nav-text">Sharing
Resources Between Tests in the Same Test Case</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#global-set-up-and-tear-down"><span class="nav-number"></span> <span class="nav-text">Global Set-Up and Tear-Down</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#value-parameterized-tests"><span class="nav-number"></span> <span class="nav-text">Value Parameterized Tests</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-write-value-parameterized-tests"><span class="nav-number">1.</span> <span class="nav-text">How to Write
Value-Parameterized Tests</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#creating-value-parameterized-abstract-tests"><span class="nav-number">2.</span> <span class="nav-text">Creating
Value-Parameterized Abstract Tests</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#typed-tests"><span class="nav-number"></span> <span class="nav-text">Typed Tests</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#type-parameterized-tests"><span class="nav-number"></span> <span class="nav-text">Type-Parameterized Tests</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#testing-private-code"><span class="nav-number"></span> <span class="nav-text">Testing Private Code</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#static-functions"><span class="nav-number">1.</span> <span class="nav-text">Static Functions</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#private-class-members"><span class="nav-number">2.</span> <span class="nav-text">Private Class Members</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#catching-failures"><span class="nav-number"></span> <span class="nav-text">Catching Failures</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#getting-the-current-tests-name"><span class="nav-number"></span> <span class="nav-text">Getting the Current Test&#39;s
Name</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#extending-google-test-by-handling-test-events"><span class="nav-number"></span> <span class="nav-text">Extending Google
Test by Handling Test Events</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#defining-event-listeners"><span class="nav-number">1.</span> <span class="nav-text">Defining Event Listeners</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#using-event-listeners"><span class="nav-number">2.</span> <span class="nav-text">Using Event Listeners</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#generating-failures-in-listeners"><span class="nav-number">3.</span> <span class="nav-text">Generating Failures in
Listeners</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#running-test-programs-advanced-options"><span class="nav-number"></span> <span class="nav-text">Running Test Programs:
Advanced Options</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#selecting-tests"><span class="nav-number">1.</span> <span class="nav-text">Selecting Tests</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#listing-test-names"><span class="nav-number">1.1.</span> <span class="nav-text">Listing Test Names</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#running-a-subset-of-the-tests"><span class="nav-number">1.2.</span> <span class="nav-text">Running a Subset of the
Tests</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#temporarily-disabling-tests"><span class="nav-number">1.3.</span> <span class="nav-text">Temporarily Disabling Tests</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#temporarily-enabling-disabled-tests"><span class="nav-number">1.4.</span> <span class="nav-text">Temporarily Enabling
Disabled Tests</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#repeating-the-tests"><span class="nav-number">2.</span> <span class="nav-text">Repeating the Tests</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shuffling-the-tests"><span class="nav-number">3.</span> <span class="nav-text">Shuffling the Tests</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#controlling-test-output"><span class="nav-number">4.</span> <span class="nav-text">Controlling Test Output</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#colored-terminal-output"><span class="nav-number">4.1.</span> <span class="nav-text">Colored Terminal Output</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#suppressing-the-elapsed-time"><span class="nav-number">4.2.</span> <span class="nav-text">Suppressing the Elapsed Time</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#generating-an-xml-report"><span class="nav-number">4.3.</span> <span class="nav-text">Generating an XML Report</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#controlling-how-failures-are-reported"><span class="nav-number">5.</span> <span class="nav-text">Controlling How Failures
Are Reported</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#turning-assertion-failures-into-break-points"><span class="nav-number">5.1.</span> <span class="nav-text">Turning Assertion
Failures into Break-Points</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#disabling-catching-test-thrown-exceptions"><span class="nav-number">5.2.</span> <span class="nav-text">Disabling Catching
Test-Thrown Exceptions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#letting-another-testing-framework-drive"><span class="nav-number">5.3.</span> <span class="nav-text">Letting Another Testing
Framework Drive</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#distributing-test-functions-to-multiple-machines"><span class="nav-number">6.</span> <span class="nav-text">Distributing
Test Functions to Multiple Machines</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#fusing-google-test-source-files"><span class="nav-number"></span> <span class="nav-text">Fusing Google Test Source
Files</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#where-to-go-from-here-1"><span class="nav-number"></span> <span class="nav-text">Where to Go from Here</span></a></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="CharlesCao"
      src="/images/bird.png">
  <p class="site-author-name" itemprop="name">CharlesCao</p>
  <div class="site-description" itemprop="description">In me the tiger sniffs the rose.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="mailto:caowenlong92@gmail.com" title="E-Mail → mailto:caowenlong92@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/5221628" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;5221628" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/cwlseu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cwlseu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://pytorch.org/" title="https:&#x2F;&#x2F;pytorch.org" rel="noopener" target="_blank">Pytorch</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://cplusplus.com/reference" title="https:&#x2F;&#x2F;cplusplus.com&#x2F;reference" rel="noopener" target="_blank">CppReference</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://docs.nvidia.com/cuda/index.html" title="https:&#x2F;&#x2F;docs.nvidia.com&#x2F;cuda&#x2F;index.html" rel="noopener" target="_blank">NVIDIA CUDA</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/cwlseu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://www.deepindeed.cn/201811/20181111-hight-property-codes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/bird.png">
      <meta itemprop="name" content="CharlesCao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Deepindeed">
      <meta itemprop="description" content="In me the tiger sniffs the rose.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="《高质量的C++代码笔记》 | Deepindeed">
      <meta itemprop="description" content="软件质量是被大多数程序员挂在嘴上而不是放在心上的东西！有多少软件开发人员对正确性、健壮性、可靠性、效率、易用性、可读性（可理解性）、可扩展性、可复用性、兼容性、可移植性等质量属性了如指掌？并且能在实践中运用自如？。">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          《高质量的C++代码笔记》
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-11-11 20:59:59" itemprop="dateCreated datePublished" datetime="2018-11-11T20:59:59+08:00">2018-11-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-03 04:05:26" itemprop="dateModified" datetime="2022-09-03T04:05:26+08:00">2022-09-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/blog/" itemprop="url" rel="index"><span itemprop="name">blog</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">评论数：</span>
  
    <a title="waline" href="/201811/20181111-hight-property-codes/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/201811/20181111-hight-property-codes/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>106k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2:56</span>
    </span>
</div>

            <div class="post-description">软件质量是被大多数程序员挂在嘴上而不是放在心上的东西！有多少软件开发人员对正确性、健壮性、可靠性、效率、易用性、可读性（可理解性）、可扩展性、可复用性、兼容性、可移植性等质量属性了如指掌？并且能在实践中运用自如？。</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="引言">引言</h2>
<p>软件质量是被大多数程序员挂在嘴上而不是放在心上的东西！
除了完全外行和真正的编程高手外，初读本书，你最先的感受将是惊慌：“哇！我
以前捏造的 C++/C
程序怎么会有那么多的毛病？”有多少软件开发人员对正确性、健壮性、可靠性、效率、易用性、可读性（可理解性）、可扩展性、可复用性、兼容性、可移植性等质量属性了如指掌？并且能在实践中运用自如？。至少我现在还不是，我只能将平时遇到的一些值得记录的东西记录下来，以供下次翻阅。</p>
<h2 id="从小程序看问题">从小程序看问题</h2>
<p><code>strcpy</code>的实现可以看出一个人的 * 编程风格 * 出错处理 *
算法复杂度分析</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span>* <span class="title">strcpy</span><span class="params">(<span class="type">char</span>* dest, <span class="type">const</span> <span class="type">char</span>* source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> * destcopy = dest;</span><br><span class="line">    <span class="keyword">if</span>((dest == <span class="literal">NULL</span>) || (source == <span class="literal">NULL</span>))</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&quot;Invalid Arguments&quot;</span>;</span><br><span class="line">    <span class="keyword">while</span>((*dest++=*source++)!= <span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> destcopy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="文件结构">文件结构</h2>
<ol type="1">
<li>声明在头文件.h，定义在源代码文件.cpp或者.c .cc</li>
<li>为了防止头文件被重复引用，应当用 ifndef/define/endif 结构产生预
处理块。</li>
<li>用 #include &lt;filename.h&gt; 格式来引用标准库的头文件（编译器将
从标准库目录开始搜索）。用 #include “filename.h”
格式来引用非标准库的头文件（编译器将从用户的工作目录开始搜索）。 4.
头文件中只存放“声明”而不存放“定义”</li>
<li>不提倡使用全局变量， 尽量不要在头文件中出现象 extern int value 这
类声明。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Copyright (c) 2001,上海贝尔有限公司网络应用事业部</span></span><br><span class="line"><span class="comment">* All rights reserved.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 文件名称： filename.h</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* 文件标识： 见配置管理计划书</span></span><br><span class="line"><span class="comment">* 摘 要： 简要描述本文件的内容</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 当前版本： 1.1</span></span><br><span class="line"><span class="comment">* 作 者： 输入作者（或修改者）名字</span></span><br><span class="line"><span class="comment">* 完成日期： 2001年7月20日</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 取代版本： 1.0</span></span><br><span class="line"><span class="comment">* 原作者 ： 输入原作者（或修改者）名字</span></span><br><span class="line"><span class="comment">* 完成日期： 2001年5月10日</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="为什么要声明和定义分离">为什么要声明和定义分离：</h3>
<ol type="1">
<li>通过头文件来调用库功能。在很多场合，源代码不便（或不准）向用户公布，只
要向用户提供头文件和二进制的库即可。用户只需要按照头文件中的接口声明来调用库
功能，而不必关心接口怎么实现的。编译器会从库中提取相应的代码。</li>
<li>头文件能加强类型安全检查。如果某个接口被实现或被使用时，其方式与头文件
中的声明不一致，编译器就会指出错误，这一简单的规则能大大减轻程序员调试、改错
的负担。</li>
<li>便于管理。如果代码文件比较多，可以将头文件放到include目录下，源文件放到source目录下，方便分别管理</li>
</ol>
<h2 id="程序">程序</h2>
<ol type="1">
<li>在每个类声明之后、每个函数定义结束之后都要加空行</li>
<li>在一个函数体内，逻揖上密切相关的语句之间不加空行，其它地方应
加空行分隔。</li>
<li>一行代码只做一件事情，如只定义一个变量，或只写一条语句。</li>
<li>if、 for、 while、 do 等语句自占一行，执行语句不得紧跟其后。不论
执行语句有多少都要加{}。这样可以防止书写失误。</li>
<li>尽可能在定义变量的同时初始化该变量。如果变量的引用处和其定义处相隔比较远，变量的初始化很容易被忘记。如果引用了未被初始化的变量，可能会导致程序错误。本建议可以减少隐患。</li>
</ol>
<h3 id="指针声明">指针声明</h3>
<p>修饰符 * 和 ＆ 应该靠近数据类型还是该靠近变量名，是个有争议的活题。
若将修饰符 * 靠近数据类型，例如： int* x; 从语义上讲此写法比较直观，即 x
是 int 类型的指针。 上述写法的弊端是容易引起误解，例如： int* x, y; 此处
y 容易被误解为指针变 量。虽然将 x 和 y
分行定义可以避免误解，但并不是人人都愿意这样做。</p>
<h2 id="命名规则">命名规则</h2>
<p>unix系统中常常采用小写字母+_ 的方式 g_:全局变量 k_:static 变量
m_：class成员变量</p>
<h2
id="类的构造函数析构函数和赋值函数">类的构造函数、析构函数和赋值函数</h2>
<p>每个类只有一个析构函数和一个赋值函数，但可以有多个构造函数（包含一个拷贝
构造函数，其它的称为普通构造函数）。对于任意一个类
A，如果不想编写上述函数， C++编译器将自动为 A 产生四个缺省的函数，如
<code>A(void);</code> // 缺省的无参数构造函数
<code>A(const A &amp;a);</code> // 缺省的拷贝构造函数
<code>~A(void);</code> // 缺省的析构函数
<code>A &amp; operate =(const A &amp;a);</code> // 缺省的赋值函数</p>
<h2 id="经验">经验</h2>
<p>不少难以察觉的程序错误是由于变量没有被正确初始化或清除造成的，而初始化和清除工作很容易被人遗忘。</p>
<h2 id="调试经典">调试经典</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> stub  fprintf(stderr, <span class="string">&quot;error param in %s:%s:%d\n&quot;</span>,  __FUNCTION__, __FILE__, __LINE__);</span></span><br></pre></td></tr></table></figure>
<h2
id="mutable关键字用来解决常函数中不能修改对象的数据成员的问题">mutable关键字用来解决常函数中不能修改对象的数据成员的问题</h2>
<h2 id="内存对齐">内存对齐</h2>
<p>这是因为结构体内存分配有自己的对齐规则，结构体内存对齐默认的规则如下：
* 分配内存的顺序是按照声明的顺序。 *
每个变量相对于起始位置的偏移量必须是该变量类型大小的整数倍，不是整数倍空出内存，直到偏移量是整数倍为止。
* 最后整个结构体的大小必须是里面变量类型最大值的整数倍。</p>
<p>内存对齐<a target="_blank" rel="noopener" href="https://www.cnblogs.com/suntp/p/MemAlignment.html"
class="uri">https://www.cnblogs.com/suntp/p/MemAlignment.html</a></p>
<p>OpenCV中16b对齐的内存申请和释放 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CV_MALLOC_ALIGN 16</span></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">  Aligns pointer by the certain number of bytes</span></span><br><span class="line"><span class="comment">  This small inline function aligns the pointer by the certian number of bytes by shifting</span></span><br><span class="line"><span class="comment">  it forward by 0 or a positive offset.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> _Tp&gt; </span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> _Tp* <span class="title">alignPtr</span><span class="params">(_Tp* ptr, <span class="type">int</span> n=(<span class="type">int</span>)<span class="keyword">sizeof</span>(_Tp))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (_Tp*)(((<span class="type">size_t</span>)ptr + n<span class="number">-1</span>) &amp; -n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">  Aligns buffer size by the certain number of bytes</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  This small inline function aligns a buffer size by the certian number of bytes by enlarging it.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span> <span class="title">alignSize</span><span class="params">(<span class="type">size_t</span> sz, <span class="type">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>((n &amp; (n - <span class="number">1</span>)) == <span class="number">0</span>); <span class="comment">// n is a power of 2</span></span><br><span class="line">    <span class="keyword">return</span> (sz + n<span class="number">-1</span>) &amp; -n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">fastMalloc</span><span class="params">( <span class="type">size_t</span> size )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    uchar* udata = (uchar*)<span class="built_in">malloc</span>(size + <span class="built_in">sizeof</span>(<span class="type">void</span>*) + CV_MALLOC_ALIGN);</span><br><span class="line">    <span class="keyword">if</span>(!udata)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">OutOfMemoryError</span>(size);</span><br><span class="line">    uchar** adata = <span class="built_in">alignPtr</span>((uchar**)udata + <span class="number">1</span>, CV_MALLOC_ALIGN);</span><br><span class="line">    adata[<span class="number">-1</span>] = udata;</span><br><span class="line">    <span class="keyword">return</span> adata;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fastFree</span><span class="params">(<span class="type">void</span>* ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ptr) &#123;</span><br><span class="line">        uchar* udata = ((uchar**)ptr)[<span class="number">-1</span>];</span><br><span class="line">        <span class="built_in">CV_DbgAssert</span>(udata &lt; (uchar*)ptr &amp;&amp;</span><br><span class="line">               ((uchar*)ptr - udata) &lt;= (<span class="type">ptrdiff_t</span>)(<span class="built_in">sizeof</span>(<span class="type">void</span>*)+CV_MALLOC_ALIGN));</span><br><span class="line">        <span class="built_in">free</span>(udata);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p><a
target="_blank" rel="noopener" href="https://www.jianshu.com/p/9c58dd414e5f">NCNN中使用该code进行内存对齐</a></p>
<h2
id="内存的作用域不要在函数中创建临时对象返回">内存的作用域，不要在函数中创建临时对象返回</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="comment">///@brief 模型配置结构体</span></span><br><span class="line"><span class="comment">///@warning 该结构体在与did_model_set_config一起使用时，一定要先全部填充为0，再设置所需要的field。</span></span><br><span class="line"><span class="comment">/// set_model_config/get_model_config 是对该结构体的浅拷贝</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">net_config_t</span> &#123;</span><br><span class="line">	<span class="type">int</span>  engine;</span><br><span class="line"></span><br><span class="line">	<span class="comment">///@brief each engine specific data can be passed to here, such as snpe_runtime, tensorrt_batch_size, ocl_context and so on.</span></span><br><span class="line">	<span class="comment">///@note each engine implementation will cast it to the corresponding runtime type, such as snpe_context_t, ppl_context_t.</span></span><br><span class="line">	<span class="comment">/// The lifetime of this pointer should span until create_handle finished, and the memory is managed by users.</span></span><br><span class="line">	<span class="type">void</span>* engine_context;</span><br><span class="line">&#125; <span class="type">net_config_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">set_net_config_t</span><span class="params">(<span class="type">net_config_t</span>* config, <span class="type">int</span> engine_type)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(config, <span class="number">0</span>, <span class="built_in">sizeof</span>(<span class="type">net_config_t</span>));</span><br><span class="line">    <span class="type">int</span> otherc[] = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>&#125;;</span><br><span class="line">    config-&gt;engine = engine_type;</span><br><span class="line">    config-&gt;engine_context = (<span class="type">void</span>*)&amp;otherc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="type">net_config_t</span> config;</span><br><span class="line">    <span class="comment">// 设置模型加载配置项</span></span><br><span class="line">    <span class="built_in">set_net_config_t</span>(&amp;config, <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;config.engine %d\n&quot;</span>, config.engine);</span><br><span class="line">    <span class="type">int</span>* context = (<span class="type">int</span>*)config.engine_context;</span><br><span class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;config.engine_context[0]=%d\n&quot;</span>, context[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;config.engine_context[1]=%d\n&quot;</span>, context[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;config.engine_context[2]=%d\n&quot;</span>, context[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第一次运行</p>
</blockquote>
<p>config.engine 3 config.engine_context[0]=1286489600
config.engine_context[1]=32624 config.engine_context[2]=1288667592</p>
<blockquote>
<p>第二次运行</p>
</blockquote>
<p>config.engine 3 config.engine_context[0]=-204200448
config.engine_context[1]=32695 config.engine_context[2]=-202022456</p>
<p>从结果中可以看出engine_context中的内存是一块未初始化的内存空间。这是因为返回的局部数组被释放导致的结果。
这情况可能导致你的程序有不期望的执行结果。尤其是如果采用context[1]作为分支判断条件，本来应该为0或者false，
现在可能是正数，也可能是负数，为0的概率非常小。因此我们要避免这种返回局部变量的情况。</p>
<h2
id="disable-copy和assign操作的方法-将赋值函数和拷贝构造函数显示作为private下">Disable
COPY和ASSIGN操作的方法， 将赋值函数和拷贝构造函数显示作为private下</h2>
<blockquote>
<p>方案 1</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A macro to disallow copy constructor and operator=</span></span><br><span class="line"><span class="comment">// This should be used in the private: declarations for a class.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GTEST_DISALLOW_COPY_AND_ASSIGN_(type)\</span></span><br><span class="line"><span class="meta">  type(type const &amp;);\</span></span><br><span class="line"><span class="meta">  void operator=(type const &amp;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestFactoryBase</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="built_in">GTEST_DISALLOW_COPY_AND_ASSIGN_</span>(TestFactoryBase);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>方案2</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">P</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">P</span>(<span class="type">const</span> P &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    P &amp;<span class="keyword">operator</span> =（<span class="type">const</span> P &amp;p) = <span class="keyword">delete</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以上两个delete声明禁止复制
能够通过明确的方式显式限定这些特殊方法有助于增强代码的可读性和可维护性</p>
<h2 id="i和i的重载代码实现">++i和i++的重载代码实现</h2>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ClassName&amp; <span class="keyword">operator</span>++()</span><br><span class="line">&#123;</span><br><span class="line">    ++cur;</span><br><span class="line">    <span class="keyword">if</span>(cur == last)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">set_node</span>(node + <span class="number">1</span>);</span><br><span class="line">      cur = first;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ClassName <span class="title">operator</span><span class="params">(<span class="type">int</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   ClassName tmp = *<span class="keyword">this</span>;</span><br><span class="line">   ++*<span class="keyword">this</span>;</span><br><span class="line">   <span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2
id="unsigned类型的默认转化造成的苦恼">unsigned类型的默认转化造成的苦恼</h2>
<p>u32Width是unsigned
int类型的，在进行计算过程中如果<code>u32Width=2</code>，执行到<code>for (; j &lt;= u32Width - 4; j += 4)</code>的时候，会出现问题：
由于j是size_t类型的，
<code>u32Width-4</code>会被转化为<code>unsigned int</code>类型，从而造成该判断可通过，从直观上看来就发生了
<code>j &lt;= -2</code>(实际是<code>j &lt;= 4294967294</code>)是为<code>true</code>的事情了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> blob_len = u32Num * u32Chn * u32Height;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; blob_len; ++i) &#123;</span><br><span class="line">	<span class="type">size_t</span> j = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (; j &lt;= u32Width - <span class="number">4</span>; j += <span class="number">4</span>) &#123;</span><br><span class="line">		dataDstBlob[j] = (dst_type)(ps32Ptr[j] * NNIE_DATA_SCALE_INV);</span><br><span class="line">		dataDstBlob[j + <span class="number">1</span>] = (dst_type)(ps32Ptr[j + <span class="number">1</span>] * NNIE_DATA_SCALE_INV);</span><br><span class="line">		dataDstBlob[j + <span class="number">2</span>] = (dst_type)(ps32Ptr[j + <span class="number">2</span>] * NNIE_DATA_SCALE_INV);</span><br><span class="line">		dataDstBlob[j + <span class="number">3</span>] = (dst_type)(ps32Ptr[j + <span class="number">3</span>] * NNIE_DATA_SCALE_INV);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (; j &lt; u32Width; ++j) &#123;</span><br><span class="line">		dataDstBlob[j] = (dst_type)(ps32Ptr[j] * NNIE_DATA_SCALE_INV);</span><br><span class="line">	&#125;</span><br><span class="line">	dataDstBlob += u32Width;</span><br><span class="line">	ps32Ptr += blob-&gt;u32Stride / <span class="built_in">getElemSize</span>(blob-&gt;enType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="c中容易忽略的库bitset">C++中容易忽略的库bitset</h2>
<p>bitset是处理<em>进制转换</em>，<em>基于bit的算法</em>中简单算法，虽然也可以使用raw的char
array替代，但是很多bitset自带的方法，可以让程序飞起来。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bitset&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">increment</span><span class="params">(std::bitset&lt;<span class="number">5</span>&gt;&amp; bset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(bset[i] == <span class="number">1</span>)</span><br><span class="line">            bset[i] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            bset[i] = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">method_1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; ++i) &#123;</span><br><span class="line">        <span class="function">std::bitset&lt;5&gt; <span class="title">bset</span><span class="params">(i)</span></span>;</span><br><span class="line">        std::cout &lt;&lt; bset &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="function">std::bitset&lt;5&gt; <span class="title">bset</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; ++i) &#123;</span><br><span class="line">        std::cout &lt;&lt; bset &lt;&lt; std::endl;</span><br><span class="line">        <span class="built_in">increment</span>(bset);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="仿函数">仿函数</h2>
<p>仿函数(functor)，就是使一个类的使用看上去象一个函数。其实现就是类中实现一个
operator()，这个类就有了类似函数的行为，就是一个仿函数类了。C语言使用函数指针和回调函数来实现仿函数，例如一个用来排序的函数可以这样使用仿函数.在C++里，我们通过在一个类中重载括号运算符的方法使用一个函数对象而不是一个普通函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">xxx</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">returnType <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> T&amp; x)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> returnType;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">display</span>  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> T &amp;x)</span>  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        cout&lt;&lt;x&lt;&lt;<span class="string">&quot; &quot;</span>;   </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;;   </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span>  </span></span><br><span class="line"><span class="comment">//int sort_function( const void *a, const void *b);  </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sort_function</span><span class="params">( <span class="type">const</span> <span class="type">void</span> *a, <span class="type">const</span> <span class="type">void</span> *b)</span>  </span><br><span class="line">&#123;     </span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">int</span>*)a-*(<span class="type">int</span>*)b;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>  </span><br><span class="line">&#123;  </span><br><span class="line">     </span><br><span class="line">   <span class="type">int</span> <span class="built_in">list</span>[<span class="number">5</span>] = &#123; <span class="number">54</span>, <span class="number">21</span>, <span class="number">11</span>, <span class="number">67</span>, <span class="number">22</span> &#125;;  </span><br><span class="line">   qsort((<span class="type">void</span> *)<span class="built_in">list</span>, <span class="number">5</span>, <span class="keyword">sizeof</span>(<span class="built_in">list</span>[<span class="number">0</span>]), sort_function);<span class="comment">//起始地址，个数，元素大小，回调函数   </span></span><br><span class="line">   <span class="type">int</span>  x;  </span><br><span class="line">   <span class="keyword">for</span> (x = <span class="number">0</span>; x &lt; <span class="number">5</span>; x++)  </span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%i\n&quot;</span>, <span class="built_in">list</span>[x]);  </span><br><span class="line">                    </span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<h3 id="仿函数在stl中的定义">仿函数在STL中的定义</h3>
<p>要使用STL内建的仿函数，必须包含<functional>头文件。而头文件中包含的仿函数分类包括</p>
<ol type="1">
<li>算术类仿函数 加：plus<T> 减：minus<T> 乘：multiplies<T>
除：divides<T> 模取：modulus<T> 否定：negate<T></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;numeric&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span>   </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span>   </span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="type">int</span> ia[]=&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;;  </span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">iv</span><span class="params">(ia,ia+<span class="number">5</span>)</span></span>;  </span><br><span class="line">    cout&lt;&lt;<span class="built_in">accumulate</span>(iv.<span class="built_in">begin</span>(),iv.<span class="built_in">end</span>(),<span class="number">1</span>,<span class="built_in">multiplies</span>&lt;<span class="type">int</span>&gt;())&lt;&lt;endl;   </span><br><span class="line">      </span><br><span class="line">    cout&lt;&lt;<span class="built_in">multiplies</span>&lt;<span class="type">int</span>&gt;()(<span class="number">3</span>,<span class="number">5</span>)&lt;&lt;endl;  </span><br><span class="line">      </span><br><span class="line">    modulus&lt;<span class="type">int</span>&gt;  modulusObj;  </span><br><span class="line">    cout&lt;&lt;<span class="built_in">modulusObj</span>(<span class="number">3</span>,<span class="number">5</span>)&lt;&lt;endl; <span class="comment">// 3   </span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;   </span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>关系运算类仿函数</li>
</ol>
<p>等于：equal_to<T> 不等于：not_equal_to<T> 大于：greater<T>
大于等于：greater_equal<T> 小于：less<T> 小于等于：less_equal<T></p>
<p>从大到小排序：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span>   </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;   </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">display</span>  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> T &amp;x)</span>  </span></span><br><span class="line"><span class="function">    </span>&#123;  </span><br><span class="line">        cout&lt;&lt;x&lt;&lt;<span class="string">&quot; &quot;</span>;   </span><br><span class="line">    &#125;   </span><br><span class="line">&#125;;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="type">int</span> ia[]=&#123;<span class="number">1</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">2</span>&#125;;  </span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">iv</span><span class="params">(ia,ia+<span class="number">5</span>)</span></span>;  </span><br><span class="line">    <span class="built_in">sort</span>(iv.<span class="built_in">begin</span>(),iv.<span class="built_in">end</span>(),<span class="built_in">greater</span>&lt;<span class="type">int</span>&gt;());  </span><br><span class="line">    for_each(iv.<span class="built_in">begin</span>(),iv.<span class="built_in">end</span>(),<span class="built_in">display</span>&lt;<span class="type">int</span>&gt;());   </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;   </span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li>逻辑运算仿函数</li>
</ol>
<p>逻辑与：logical_and<T> 逻辑或：logical_or<T>
逻辑否：logical_no<T></p>
<h2 id="google-test的一些疑问test_f与test的区别">google
test的一些疑问：TEST_F与TEST的区别</h2>
<p>TEST_F与TEST的区别是，TEST_F提供了一个初始化函数（SetUp）和一个清理函数(TearDown)，在TEST_F中使用的变量可以在初始化函数SetUp中初始化，在TearDown中销毁，并且所有的TEST_F是互相独立的，都是在初始化以后的状态开始运行，一个TEST_F不会影响另一个TEST_F所使用的数据。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//A.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> A_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> A_H</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">　　<span class="type">int</span> _a;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">　　<span class="built_in">A</span>( <span class="type">int</span> a );</span><br><span class="line">　　~<span class="built_in">A</span>( );</span><br><span class="line">　　<span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">( <span class="type">int</span> a )</span></span>;</span><br><span class="line">　　<span class="function"><span class="type">int</span> <span class="title">getA</span><span class="params">( )</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">A.cpp</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;A.h&quot;</span></span></span><br><span class="line">A::<span class="built_in">A</span>( <span class="type">int</span> a )&#123;</span><br><span class="line">　　<span class="keyword">this</span>-&gt;_a = a;</span><br><span class="line">&#125;</span><br><span class="line">A::~<span class="built_in">A</span>( )&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">A::add</span><span class="params">( <span class="type">int</span> a )</span></span>&#123;</span><br><span class="line">　　<span class="keyword">this</span>-&gt;_a += a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">A::getA</span><span class="params">( )</span></span>&#123;</span><br><span class="line">　　<span class="keyword">return</span> <span class="keyword">this</span>-&gt;_a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>A_test.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 　A_test.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;A.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gtest/gtest.h&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A_test</span> : <span class="keyword">public</span> testing::Test &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">　　A* _p_a;</span><br><span class="line">　　<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">SetUp</span><span class="params">( )</span></span>&#123;　　　<span class="comment">//初始化函数</span></span><br><span class="line">　　　　<span class="keyword">this</span>-&gt;_p_a = <span class="keyword">new</span> <span class="built_in">A</span>( <span class="number">1</span> );</span><br><span class="line">　　&#125;</span><br><span class="line">　　<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">TearDown</span><span class="params">( )</span></span>&#123;　 <span class="comment">//清理函数</span></span><br><span class="line">　　　　<span class="keyword">delete</span> <span class="keyword">this</span>-&gt;_p_a;</span><br><span class="line">　　&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//第一个测试，参数A_test是上面的那个类，第二个参数FirstAdd是测试名称</span></span><br><span class="line"><span class="built_in">TEST_F</span>( A_test,FirstAdd )&#123;　　　　</span><br><span class="line">　　<span class="built_in">EXPECT_EQ</span>( <span class="number">1</span>,_p_a-&gt;<span class="built_in">getA</span>( ) );</span><br><span class="line">　　_p_a-&gt;<span class="built_in">add</span>( <span class="number">3</span> );</span><br><span class="line">　　<span class="built_in">EXPECT_EQ</span>( <span class="number">4</span>,_p_a-&gt;<span class="built_in">getA</span>( ) );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//第二个测试</span></span><br><span class="line"><span class="built_in">TEST_F</span>( A_test,SecondAdd )&#123;</span><br><span class="line">　　<span class="built_in">EXPECT_EQ</span>( <span class="number">1</span>,_p_a-&gt;<span class="built_in">getA</span>( ) );</span><br><span class="line">　　_p_a-&gt;<span class="built_in">add</span>( <span class="number">5</span> );</span><br><span class="line">　　<span class="built_in">EXPECT_EQ</span>( <span class="number">6</span>,_p_a-&gt;<span class="built_in">getA</span>( ) );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">上面的两个测试都是在SetUp函数执行后的状态下执行，也就是说在执行任意一个TEST_F时 _p_a-&gt;_a 的值都是初始值1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<ul>
<li>main.cpp</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gtest/gtest.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">　　testing::<span class="built_in">InitGoogleTest</span>(&amp;argc, argv);</span><br><span class="line">　　<span class="keyword">return</span> <span class="built_in">RUN_ALL_TESTS</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __TIC__()                                    \</span></span><br><span class="line"><span class="meta">	struct timeval __timing_start, __timing_end; \</span></span><br><span class="line"><span class="meta">	gettimeofday(&amp;__timing_start, NULL);</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __TOC__()                                                        \</span></span><br><span class="line"><span class="meta">	do &#123;                                                             \</span></span><br><span class="line"><span class="meta">		gettimeofday(&amp;__timing_end, NULL);                       \</span></span><br><span class="line"><span class="meta">		double __timing_gap = (__timing_end.tv_sec -     \</span></span><br><span class="line"><span class="meta">					       __timing_start.tv_sec) *  \</span></span><br><span class="line"><span class="meta">					      1000.0 +                     \</span></span><br><span class="line"><span class="meta">				      (__timing_end.tv_usec -    \</span></span><br><span class="line"><span class="meta">					       __timing_start.tv_usec) / \</span></span><br><span class="line"><span class="meta">					      1000.0;                    \</span></span><br><span class="line"><span class="meta">		fprintf(stdout, <span class="string">&quot;TIME(ms): %lf\n&quot;</span>, __timing_gap);        \</span></span><br><span class="line"><span class="meta">	&#125; while (0)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="看看gtest的工作流程">看看gtest的工作流程</h2>
<ul>
<li>入口</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一个测试，参数A_test是上面的那个类，第二个参数FirstAdd是测试名称</span></span><br><span class="line"><span class="built_in">TEST</span>(A_test, FirstAdd)&#123;　　　　</span><br><span class="line">　　<span class="built_in">EXPECT_EQ</span>( <span class="number">1</span>,_p_a-&gt;<span class="built_in">getA</span>( ) );</span><br><span class="line">　　_p_a-&gt;<span class="built_in">add</span>( <span class="number">3</span> );</span><br><span class="line">　　<span class="built_in">EXPECT_EQ</span>( <span class="number">4</span>,_p_a-&gt;<span class="built_in">getA</span>( ) );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Define this macro to 1 to omit the definition of TEST(), which</span></span><br><span class="line"><span class="comment">// is a generic name and clashes with some other libraries.</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !GTEST_DONT_DEFINE_TEST</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> TEST(test_case_name, test_name) GTEST_TEST(test_case_name, test_name)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GTEST_TEST(test_case_name, test_name)\</span></span><br><span class="line"><span class="meta">  GTEST_TEST_(test_case_name, test_name, \</span></span><br><span class="line"><span class="meta">              ::testing::Test, ::testing::internal::GetTestTypeId())</span></span><br></pre></td></tr></table></figure>
<ul>
<li>首先看看函数中调用的一个宏的实现</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Expands to the name of the class that implements the given test.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GTEST_TEST_CLASS_NAME_(test_case_name, test_name) \</span></span><br><span class="line"><span class="meta">  test_case_name##_##test_name##_Test</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Helper macro for defining tests.</span></span><br><span class="line"><span class="comment">// 这个宏声明了一个继承自parent_class ::testing::Test的类，然后对这个类的属性test_info_进行赋值</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GTEST_TEST_(test_case_name, test_name, parent_class, parent_id)\</span></span><br><span class="line"><span class="meta">class GTEST_TEST_CLASS_NAME_(test_case_name, test_name) : public parent_class &#123;\</span></span><br><span class="line"><span class="meta"> public:\</span></span><br><span class="line"><span class="meta">  GTEST_TEST_CLASS_NAME_(test_case_name, test_name)() &#123;&#125;\</span></span><br><span class="line"><span class="meta"> private:\</span></span><br><span class="line"><span class="meta">  virtual void TestBody();\</span></span><br><span class="line"><span class="meta">  static ::testing::TestInfo* const test_info_ GTEST_ATTRIBUTE_UNUSED_;\</span></span><br><span class="line"><span class="meta">  GTEST_DISALLOW_COPY_AND_ASSIGN_(\</span></span><br><span class="line"><span class="meta">      GTEST_TEST_CLASS_NAME_(test_case_name, test_name));\</span></span><br><span class="line"><span class="meta">&#125;;\</span></span><br><span class="line"><span class="meta"><span class="comment">/*这个宏声明了一个继承自parent_class ::testing::Test的类，然后对这个类的属性test_info_进行赋值*/</span>\</span></span><br><span class="line"><span class="meta">::testing::TestInfo* const GTEST_TEST_CLASS_NAME_(test_case_name, test_name)\</span></span><br><span class="line"><span class="meta">  ::test_info_ =\</span></span><br><span class="line"><span class="meta">    ::testing::internal::MakeAndRegisterTestInfo(\</span></span><br><span class="line"><span class="meta">        #test_case_name, #test_name, NULL, NULL, \</span></span><br><span class="line"><span class="meta">        (parent_id), \</span></span><br><span class="line"><span class="meta">        parent_class::SetUpTestCase, \</span></span><br><span class="line"><span class="meta">        parent_class::TearDownTestCase, \</span></span><br><span class="line"><span class="meta">        new ::testing::internal::TestFactoryImpl&lt;\</span></span><br><span class="line"><span class="meta">            GTEST_TEST_CLASS_NAME_(test_case_name, test_name)&gt;);\</span></span><br><span class="line"><span class="meta"><span class="comment">// 实现我们的这个TestBody\</span></span></span><br><span class="line"><span class="comment"><span class="meta">void GTEST_TEST_CLASS_NAME_(test_case_name, test_name)::TestBody()</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>看一下MakeAndRegisterTestInfo函数</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TestInfo* <span class="title">MakeAndRegisterTestInfo</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">char</span>* test_case_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">char</span>* name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">char</span>* type_param,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">char</span>* value_param,</span></span></span><br><span class="line"><span class="params"><span class="function">    TypeId fixture_class_id,</span></span></span><br><span class="line"><span class="params"><span class="function">    SetUpTestCaseFunc set_up_tc,</span></span></span><br><span class="line"><span class="params"><span class="function">    TearDownTestCaseFunc tear_down_tc,</span></span></span><br><span class="line"><span class="params"><span class="function">    TestFactoryBase* factory)</span> </span>&#123;</span><br><span class="line">  TestInfo* <span class="type">const</span> test_info =</span><br><span class="line">      <span class="keyword">new</span> <span class="built_in">TestInfo</span>(test_case_name, name, type_param, value_param,</span><br><span class="line">                   fixture_class_id, factory);</span><br><span class="line">  <span class="comment">// 添加测试用例信息到UnitTestImpl的testcase_中</span></span><br><span class="line">  <span class="built_in">GetUnitTestImpl</span>()-&gt;<span class="built_in">AddTestInfo</span>(set_up_tc, tear_down_tc, test_info);</span><br><span class="line">  <span class="keyword">return</span> test_info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>AddTestInfo试图通过测试用例名等信息获取测试用例，然后调用测试用例对象去新增一个测试特例——test_info。
这样我们在此就将测试用例和测试特例的关系在代码中找到了关联。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Finds and returns a TestCase with the given name.  If one doesn&#x27;t</span></span><br><span class="line"><span class="comment">// exist, creates one and returns it.  It&#x27;s the CALLER&#x27;S</span></span><br><span class="line"><span class="comment">// RESPONSIBILITY to ensure that this function is only called WHEN THE</span></span><br><span class="line"><span class="comment">// TESTS ARE NOT SHUFFLED.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Arguments:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   test_case_name: name of the test case</span></span><br><span class="line"><span class="comment">//   type_param:     the name of the test case&#x27;s type parameter, or NULL if</span></span><br><span class="line"><span class="comment">//                   this is not a typed or a type-parameterized test case.</span></span><br><span class="line"><span class="comment">//   set_up_tc:      pointer to the function that sets up the test case</span></span><br><span class="line"><span class="comment">//   tear_down_tc:   pointer to the function that tears down the test case</span></span><br><span class="line"><span class="function">TestCase* <span class="title">UnitTestImpl::GetTestCase</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* test_case_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> <span class="type">char</span>* type_param,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Test::SetUpTestCaseFunc set_up_tc,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Test::TearDownTestCaseFunc tear_down_tc)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Can we find a TestCase with the given name?</span></span><br><span class="line">  <span class="type">const</span> std::vector&lt;TestCase*&gt;::const_iterator test_case =</span><br><span class="line">      std::<span class="built_in">find_if</span>(test_cases_.<span class="built_in">begin</span>(), test_cases_.<span class="built_in">end</span>(),</span><br><span class="line">                   <span class="built_in">TestCaseNameIs</span>(test_case_name));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (test_case != test_cases_.<span class="built_in">end</span>())</span><br><span class="line">    <span class="keyword">return</span> *test_case;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// No.  Let&#x27;s create one.</span></span><br><span class="line">  TestCase* <span class="type">const</span> new_test_case =</span><br><span class="line">      <span class="keyword">new</span> <span class="built_in">TestCase</span>(test_case_name, type_param, set_up_tc, tear_down_tc);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Is this a death test case?</span></span><br><span class="line">  <span class="keyword">if</span> (internal::UnitTestOptions::<span class="built_in">MatchesFilter</span>(test_case_name,</span><br><span class="line">                                               kDeathTestCaseFilter)) &#123;</span><br><span class="line">    <span class="comment">// Yes.  Inserts the test case after the last death test case</span></span><br><span class="line">    <span class="comment">// defined so far.  This only works when the test cases haven&#x27;t</span></span><br><span class="line">    <span class="comment">// been shuffled.  Otherwise we may end up running a death test</span></span><br><span class="line">    <span class="comment">// after a non-death test.</span></span><br><span class="line">    ++last_death_test_case_;</span><br><span class="line">    test_cases_.<span class="built_in">insert</span>(test_cases_.<span class="built_in">begin</span>() + last_death_test_case_,</span><br><span class="line">                       new_test_case);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No.  Appends to the end of the list.</span></span><br><span class="line">    test_cases_.<span class="built_in">push_back</span>(new_test_case);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  test_case_indices_.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(test_case_indices_.<span class="built_in">size</span>()));</span><br><span class="line">  <span class="keyword">return</span> new_test_case;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="reference">Reference</h1>
<ul>
<li>[1]. gtest测试相关:
http://blog.csdn.net/breaksoftware/article/details/50948239</li>
<li>[2]. <a
target="_blank" rel="noopener" href="https://wenku.baidu.com/view/11d8f46527d3240c8447efa8.html">Floating-Point
Arithmetic 浮点数结构</a></li>
</ul>
<h1
id="来自gtest文档中的内容方便后续查看">来自GTEST文档中的内容，方便后续查看</h1>
<h1 id="introduction-why-google-c-testing-framework">Introduction: Why
Google C++ Testing Framework?</h1>
<p><em>Google C++ Testing Framework</em> helps you write better C++
tests.</p>
<p>No matter whether you work on Linux, Windows, or a Mac, if you write
C++ code, Google Test can help you.</p>
<p>So what makes a good test, and how does Google C++ Testing Framework
fit in? We believe: 1. Tests should be <em>independent</em> and
<em>repeatable</em>. It's a pain to debug a test that succeeds or fails
as a result of other tests. Google C++ Testing Framework isolates the
tests by running each of them on a different object. When a test fails,
Google C++ Testing Framework allows you to run it in isolation for quick
debugging. 1. Tests should be well <em>organized</em> and reflect the
structure of the tested code. Google C++ Testing Framework groups
related tests into test cases that can share data and subroutines. This
common pattern is easy to recognize and makes tests easy to maintain.
Such consistency is especially helpful when people switch projects and
start to work on a new code base. 1. Tests should be <em>portable</em>
and <em>reusable</em>. The open-source community has a lot of code that
is platform-neutral, its tests should also be platform-neutral. Google
C++ Testing Framework works on different OSes, with different compilers
(gcc, MSVC, and others), with or without exceptions, so Google C++
Testing Framework tests can easily work with a variety of
configurations. (Note that the current release only contains build
scripts for Linux - we are actively working on scripts for other
platforms.) 1. When tests fail, they should provide as much
<em>information</em> about the problem as possible. Google C++ Testing
Framework doesn't stop at the first test failure. Instead, it only stops
the current test and continues with the next. You can also set up tests
that report non-fatal failures after which the current test continues.
Thus, you can detect and fix multiple bugs in a single run-edit-compile
cycle. 1. The testing framework should liberate test writers from
housekeeping chores and let them focus on the test <em>content</em>.
Google C++ Testing Framework automatically keeps track of all tests
defined, and doesn't require the user to enumerate them in order to run
them. 1. Tests should be <em>fast</em>. With Google C++ Testing
Framework, you can reuse shared resources across tests and pay for the
set-up/tear-down only once, without making tests depend on each
other.</p>
<p>Since Google C++ Testing Framework is based on the popular xUnit
architecture, you'll feel right at home if you've used JUnit or PyUnit
before. If not, it will take you about 10 minutes to learn the basics
and get started. So let's go!</p>
<p><em>Note:</em> We sometimes refer to Google C++ Testing Framework
informally as <em>Google Test</em>.</p>
<h1 id="setting-up-a-new-test-project">Setting up a New Test
Project</h1>
<p>To write a test program using Google Test, you need to compile Google
Test into a library and link your test with it. We provide build files
for some popular build systems: <code>msvc/</code> for Visual Studio,
<code>xcode/</code> for Mac Xcode, <code>make/</code> for GNU make,
<code>codegear/</code> for Borland C++ Builder, and the autotools script
(deprecated) and <code>CMakeLists.txt</code> for CMake (recommended) in
the Google Test root directory. If your build system is not on this
list, you can take a look at <code>make/Makefile</code> to learn how
Google Test should be compiled (basically you want to compile
<code>src/gtest-all.cc</code> with <code>GTEST_ROOT</code> and
<code>GTEST_ROOT/include</code> in the header search path, where
<code>GTEST_ROOT</code> is the Google Test root directory).</p>
<p>Once you are able to compile the Google Test library, you should
create a project or build target for your test program. Make sure you
have <code>GTEST_ROOT/include</code> in the header search path so that
the compiler can find <code>"gtest/gtest.h"</code> when compiling your
test. Set up your test project to link with the Google Test library (for
example, in Visual Studio, this is done by adding a dependency on
<code>gtest.vcproj</code>).</p>
<p>If you still have questions, take a look at how Google Test's own
tests are built and use them as examples.</p>
<h1 id="basic-concepts">Basic Concepts</h1>
<p>When using Google Test, you start by writing <em>assertions</em>,
which are statements that check whether a condition is true. An
assertion's result can be <em>success</em>, <em>nonfatal failure</em>,
or <em>fatal failure</em>. If a fatal failure occurs, it aborts the
current function; otherwise the program continues normally.</p>
<p><em>Tests</em> use assertions to verify the tested code's behavior.
If a test crashes or has a failed assertion, then it <em>fails</em>;
otherwise it <em>succeeds</em>.</p>
<p>A <em>test case</em> contains one or many tests. You should group
your tests into test cases that reflect the structure of the tested
code. When multiple tests in a test case need to share common objects
and subroutines, you can put them into a <em>test fixture</em>
class.</p>
<p>A <em>test program</em> can contain multiple test cases.</p>
<p>We'll now explain how to write a test program, starting at the
individual assertion level and building up to tests and test cases.</p>
<h1 id="assertions">Assertions</h1>
<p>Google Test assertions are macros that resemble function calls. You
test a class or function by making assertions about its behavior. When
an assertion fails, Google Test prints the assertion's source file and
line number location, along with a failure message. You may also supply
a custom failure message which will be appended to Google Test's
message.</p>
<p>The assertions come in pairs that test the same thing but have
different effects on the current function. <code>ASSERT_*</code>
versions generate fatal failures when they fail, and <strong>abort the
current function</strong>. <code>EXPECT_*</code> versions generate
nonfatal failures, which don't abort the current function. Usually
<code>EXPECT_*</code> are preferred, as they allow more than one
failures to be reported in a test. However, you should use
<code>ASSERT_*</code> if it doesn't make sense to continue when the
assertion in question fails.</p>
<p>Since a failed <code>ASSERT_*</code> returns from the current
function immediately, possibly skipping clean-up code that comes after
it, it may cause a space leak. Depending on the nature of the leak, it
may or may not be worth fixing - so keep this in mind if you get a heap
checker error in addition to assertion errors.</p>
<p>To provide a custom failure message, simply stream it into the macro
using the <code>&lt;&lt;</code> operator, or a sequence of such
operators. An example: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ASSERT_EQ(x.size(), y.size()) &lt;&lt; &quot;Vectors x and y are of unequal length&quot;;</span><br><span class="line"></span><br><span class="line">for (int i = 0; i &lt; x.size(); ++i) &#123;</span><br><span class="line">  EXPECT_EQ(x[i], y[i]) &lt;&lt; &quot;Vectors x and y differ at index &quot; &lt;&lt; i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Anything that can be streamed to an <code>ostream</code> can be
streamed to an assertion macro--in particular, C strings and
<code>string</code> objects. If a wide string (<code>wchar_t*</code>,
<code>TCHAR*</code> in <code>UNICODE</code> mode on Windows, or
<code>std::wstring</code>) is streamed to an assertion, it will be
translated to UTF-8 when printed.</p>
<h2 id="basic-assertions">Basic Assertions</h2>
<p>These assertions do basic true/false condition testing.</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 40%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Fatal assertion</strong></th>
<th style="text-align: left;"><strong>Nonfatal assertion</strong></th>
<th style="text-align: left;"><strong>Verifies</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td
style="text-align: left;"><code>ASSERT_TRUE(</code><em>condition</em><code>)</code>;</td>
<td
style="text-align: left;"><code>EXPECT_TRUE(</code><em>condition</em><code>)</code>;</td>
<td style="text-align: left;"><em>condition</em> is true</td>
</tr>
<tr class="even">
<td
style="text-align: left;"><code>ASSERT_FALSE(</code><em>condition</em><code>)</code>;</td>
<td
style="text-align: left;"><code>EXPECT_FALSE(</code><em>condition</em><code>)</code>;</td>
<td style="text-align: left;"><em>condition</em> is false</td>
</tr>
</tbody>
</table>
<p>Remember, when they fail, <code>ASSERT_*</code> yields a fatal
failure and returns from the current function, while
<code>EXPECT_*</code> yields a nonfatal failure, allowing the function
to continue running. In either case, an assertion failure means its
containing test fails.</p>
<p><em>Availability</em>: Linux, Windows, Mac.</p>
<h2 id="binary-comparison">Binary Comparison</h2>
<p>This section describes assertions that compare two values.</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 40%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Fatal assertion</strong></th>
<th style="text-align: left;"><strong>Nonfatal assertion</strong></th>
<th style="text-align: left;"><strong>Verifies</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td
style="text-align: left;"><code>ASSERT_EQ(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_EQ(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td style="text-align: left;"><em>val1</em> <code>==</code>
<em>val2</em></td>
</tr>
<tr class="even">
<td
style="text-align: left;"><code>ASSERT_NE(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_NE(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td style="text-align: left;"><em>val1</em> <code>!=</code>
<em>val2</em></td>
</tr>
<tr class="odd">
<td
style="text-align: left;"><code>ASSERT_LT(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_LT(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td style="text-align: left;"><em>val1</em> <code>&lt;</code>
<em>val2</em></td>
</tr>
<tr class="even">
<td
style="text-align: left;"><code>ASSERT_LE(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_LE(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td style="text-align: left;"><em>val1</em> <code>&lt;=</code>
<em>val2</em></td>
</tr>
<tr class="odd">
<td
style="text-align: left;"><code>ASSERT_GT(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_GT(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td style="text-align: left;"><em>val1</em> <code>&gt;</code>
<em>val2</em></td>
</tr>
<tr class="even">
<td
style="text-align: left;"><code>ASSERT_GE(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_GE(</code><em>val1</em><code>,</code><em>val2</em><code>);</code></td>
<td style="text-align: left;"><em>val1</em> <code>&gt;=</code>
<em>val2</em></td>
</tr>
</tbody>
</table>
<p>In the event of a failure, Google Test prints both <em>val1</em> and
<em>val2</em>.</p>
<p>Value arguments must be comparable by the assertion's comparison
operator or you'll get a compiler error. We used to require the
arguments to support the <code>&lt;&lt;</code> operator for streaming to
an <code>ostream</code>, but it's no longer necessary since v1.6.0 (if
<code>&lt;&lt;</code> is supported, it will be called to print the
arguments when the assertion fails; otherwise Google Test will attempt
to print them in the best way it can. For more details and how to
customize the printing of the arguments, see this Google Mock <a
href="../../googlemock/docs/CookBook.md#teaching-google-mock-how-to-print-your-values">recipe</a>.).</p>
<p>These assertions can work with a user-defined type, but only if you
define the corresponding comparison operator (e.g. <code>==</code>,
<code>&lt;</code>, etc). If the corresponding operator is defined,
prefer using the <code>ASSERT_*()</code> macros because they will print
out not only the result of the comparison, but the two operands as
well.</p>
<p>Arguments are always evaluated exactly once. Therefore, it's OK for
the arguments to have side effects. However, as with any ordinary C/C++
function, the arguments' evaluation order is undefined (i.e. the
compiler is free to choose any order) and your code should not depend on
any particular argument evaluation order.</p>
<p><code>ASSERT_EQ()</code> does pointer equality on pointers. If used
on two C strings, it tests if they are in the same memory location, not
if they have the same value. Therefore, if you want to compare C strings
(e.g. <code>const char*</code>) by value, use
<code>ASSERT_STREQ()</code> , which will be described later on. In
particular, to assert that a C string is <code>NULL</code>, use
<code>ASSERT_STREQ(NULL, c_string)</code> . However, to compare two
<code>string</code> objects, you should use <code>ASSERT_EQ</code>.</p>
<p>Macros in this section work with both narrow and wide string objects
(<code>string</code> and <code>wstring</code>).</p>
<p><em>Availability</em>: Linux, Windows, Mac.</p>
<p><em>Historical note</em>: Before February 2016 <code>*_EQ</code> had
a convention of calling it as <code>ASSERT_EQ(expected, actual)</code>,
so lots of existing code uses this order. Now <code>*_EQ</code> treats
both parameters in the same way.</p>
<h2 id="string-comparison">String Comparison</h2>
<p>The assertions in this group compare two <strong>C strings</strong>.
If you want to compare two <code>string</code> objects, use
<code>EXPECT_EQ</code>, <code>EXPECT_NE</code>, and etc instead.</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 40%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Fatal assertion</strong></th>
<th style="text-align: left;"><strong>Nonfatal assertion</strong></th>
<th style="text-align: left;"><strong>Verifies</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td
style="text-align: left;"><code>ASSERT_STREQ(</code><em>str1</em><code>,</code><em>str2</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_STREQ(</code><em>str1</em><code>,</code>_str_2<code>);</code></td>
<td style="text-align: left;">the two C strings have the same
content</td>
</tr>
<tr class="even">
<td
style="text-align: left;"><code>ASSERT_STRNE(</code><em>str1</em><code>,</code><em>str2</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_STRNE(</code><em>str1</em><code>,</code><em>str2</em><code>);</code></td>
<td style="text-align: left;">the two C strings have different
content</td>
</tr>
<tr class="odd">
<td
style="text-align: left;"><code>ASSERT_STRCASEEQ(</code><em>str1</em><code>,</code><em>str2</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_STRCASEEQ(</code><em>str1</em><code>,</code><em>str2</em><code>);</code></td>
<td style="text-align: left;">the two C strings have the same content,
ignoring case</td>
</tr>
<tr class="even">
<td
style="text-align: left;"><code>ASSERT_STRCASENE(</code><em>str1</em><code>,</code><em>str2</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_STRCASENE(</code><em>str1</em><code>,</code><em>str2</em><code>);</code></td>
<td style="text-align: left;">the two C strings have different content,
ignoring case</td>
</tr>
</tbody>
</table>
<p>Note that "CASE" in an assertion name means that case is ignored.</p>
<p><code>*STREQ*</code> and <code>*STRNE*</code> also accept wide C
strings (<code>wchar_t*</code>). If a comparison of two wide strings
fails, their values will be printed as UTF-8 narrow strings.</p>
<p>A <code>NULL</code> pointer and an empty string are considered
<em>different</em>.</p>
<p><em>Availability</em>: Linux, Windows, Mac.</p>
<p>See also: For more string comparison tricks (substring, prefix,
suffix, and regular expression matching, for example), see the <a
href="AdvancedGuide.md">Advanced Google Test Guide</a>.</p>
<h1 id="simple-tests">Simple Tests</h1>
<p>To create a test: 1. Use the <code>TEST()</code> macro to define and
name a test function, These are ordinary C++ functions that don't return
a value. 1. In this function, along with any valid C++ statements you
want to include, use the various Google Test assertions to check values.
1. The test's result is determined by the assertions; if any assertion
in the test fails (either fatally or non-fatally), or if the test
crashes, the entire test fails. Otherwise, it succeeds.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEST(test_case_name, test_name) &#123;</span><br><span class="line"> ... test body ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>TEST()</code> arguments go from general to specific. The
<em>first</em> argument is the name of the test case, and the
<em>second</em> argument is the test's name within the test case. Both
names must be valid C++ identifiers, and they should not contain
underscore (<code>_</code>). A test's <em>full name</em> consists of its
containing test case and its individual name. Tests from different test
cases can have the same individual name.</p>
<p>For example, let's take a simple integer function: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int Factorial(int n); // Returns the factorial of n</span><br></pre></td></tr></table></figure></p>
<p>A test case for this function might look like: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// Tests factorial of 0.</span><br><span class="line">TEST(FactorialTest, HandlesZeroInput) &#123;</span><br><span class="line">  EXPECT_EQ(1, Factorial(0));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Tests factorial of positive numbers.</span><br><span class="line">TEST(FactorialTest, HandlesPositiveInput) &#123;</span><br><span class="line">  EXPECT_EQ(1, Factorial(1));</span><br><span class="line">  EXPECT_EQ(2, Factorial(2));</span><br><span class="line">  EXPECT_EQ(6, Factorial(3));</span><br><span class="line">  EXPECT_EQ(40320, Factorial(8));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Google Test groups the test results by test cases, so
logically-related tests should be in the same test case; in other words,
the first argument to their <code>TEST()</code> should be the same. In
the above example, we have two tests, <code>HandlesZeroInput</code> and
<code>HandlesPositiveInput</code>, that belong to the same test case
<code>FactorialTest</code>.</p>
<p><em>Availability</em>: Linux, Windows, Mac.</p>
<h1
id="test-fixtures-using-the-same-data-configuration-for-multiple-tests">Test
Fixtures: Using the Same Data Configuration for Multiple Tests</h1>
<p>If you find yourself writing two or more tests that operate on
similar data, you can use a <em>test fixture</em>. It allows you to
reuse the same configuration of objects for several different tests.</p>
<p>To create a fixture, just: 1. Derive a class from
<code>::testing::Test</code> . Start its body with
<code>protected:</code> or <code>public:</code> as we'll want to access
fixture members from sub-classes. 1. Inside the class, declare any
objects you plan to use. 1. If necessary, write a default constructor or
<code>SetUp()</code> function to prepare the objects for each test. A
common mistake is to spell <code>SetUp()</code> as <code>Setup()</code>
with a small <code>u</code> - don't let that happen to you. 1. If
necessary, write a destructor or <code>TearDown()</code> function to
release any resources you allocated in <code>SetUp()</code> . To learn
when you should use the constructor/destructor and when you should use
<code>SetUp()/TearDown()</code>, read this <a
href="FAQ.md#should-i-use-the-constructordestructor-of-the-test-fixture-or-the-set-uptear-down-function">FAQ
entry</a>. 1. If needed, define subroutines for your tests to share.</p>
<p>When using a fixture, use <code>TEST_F()</code> instead of
<code>TEST()</code> as it allows you to access objects and subroutines
in the test fixture: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEST_F(test_case_name, test_name) &#123;</span><br><span class="line"> ... test body ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Like <code>TEST()</code>, the first argument is the test case name,
but for <code>TEST_F()</code> this must be the name of the test fixture
class. You've probably guessed: <code>_F</code> is for fixture.</p>
<p>Unfortunately, the C++ macro system does not allow us to create a
single macro that can handle both types of tests. Using the wrong macro
causes a compiler error.</p>
<p>Also, you must first define a test fixture class before using it in a
<code>TEST_F()</code>, or you'll get the compiler error
"<code>virtual outside class declaration</code>".</p>
<p>For each test defined with <code>TEST_F()</code>, Google Test will:
1. Create a <em>fresh</em> test fixture at runtime 1. Immediately
initialize it via <code>SetUp()</code> , 1. Run the test 1. Clean up by
calling <code>TearDown()</code> 1. Delete the test fixture. Note that
different tests in the same test case have different test fixture
objects, and Google Test always deletes a test fixture before it creates
the next one. Google Test does not reuse the same test fixture for
multiple tests. Any changes one test makes to the fixture do not affect
other tests.</p>
<p>As an example, let's write tests for a FIFO queue class named
<code>Queue</code>, which has the following interface:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">template &lt;typename E&gt; // E is the element type.</span><br><span class="line">class Queue &#123;</span><br><span class="line"> public:</span><br><span class="line">  Queue();</span><br><span class="line">  void Enqueue(const E&amp; element);</span><br><span class="line">  E* Dequeue(); // Returns NULL if the queue is empty.</span><br><span class="line">  size_t size() const;</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>First, define a fixture class. By convention, you should give it the
name <code>FooTest</code> where <code>Foo</code> is the class being
tested. <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class QueueTest : public ::testing::Test &#123;</span><br><span class="line"> protected:</span><br><span class="line">  virtual void SetUp() &#123;</span><br><span class="line">    q1_.Enqueue(1);</span><br><span class="line">    q2_.Enqueue(2);</span><br><span class="line">    q2_.Enqueue(3);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // virtual void TearDown() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  Queue&lt;int&gt; q0_;</span><br><span class="line">  Queue&lt;int&gt; q1_;</span><br><span class="line">  Queue&lt;int&gt; q2_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>In this case, <code>TearDown()</code> is not needed since we don't
have to clean up after each test, other than what's already done by the
destructor.</p>
<p>Now we'll write tests using <code>TEST_F()</code> and this fixture.
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">TEST_F(QueueTest, IsEmptyInitially) &#123;</span><br><span class="line">  EXPECT_EQ(0, q0_.size());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST_F(QueueTest, DequeueWorks) &#123;</span><br><span class="line">  int* n = q0_.Dequeue();</span><br><span class="line">  EXPECT_EQ(NULL, n);</span><br><span class="line"></span><br><span class="line">  n = q1_.Dequeue();</span><br><span class="line">  ASSERT_TRUE(n != NULL);</span><br><span class="line">  EXPECT_EQ(1, *n);</span><br><span class="line">  EXPECT_EQ(0, q1_.size());</span><br><span class="line">  delete n;</span><br><span class="line"></span><br><span class="line">  n = q2_.Dequeue();</span><br><span class="line">  ASSERT_TRUE(n != NULL);</span><br><span class="line">  EXPECT_EQ(2, *n);</span><br><span class="line">  EXPECT_EQ(1, q2_.size());</span><br><span class="line">  delete n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The above uses both <code>ASSERT_*</code> and <code>EXPECT_*</code>
assertions. The rule of thumb is to use <code>EXPECT_*</code> when you
want the test to continue to reveal more errors after the assertion
failure, and use <code>ASSERT_*</code> when continuing after failure
doesn't make sense. For example, the second assertion in the
<code>Dequeue</code> test is <code>ASSERT_TRUE(n != NULL)</code>, as we
need to dereference the pointer <code>n</code> later, which would lead
to a segfault when <code>n</code> is <code>NULL</code>.</p>
<p>When these tests run, the following happens: 1. Google Test
constructs a <code>QueueTest</code> object (let's call it
<code>t1</code> ). 1. <code>t1.SetUp()</code> initializes
<code>t1</code> . 1. The first test ( <code>IsEmptyInitially</code> )
runs on <code>t1</code> . 1. <code>t1.TearDown()</code> cleans up after
the test finishes. 1. <code>t1</code> is destructed. 1. The above steps
are repeated on another <code>QueueTest</code> object, this time running
the <code>DequeueWorks</code> test.</p>
<p><em>Availability</em>: Linux, Windows, Mac.</p>
<p><em>Note</em>: Google Test automatically saves all <em>Google
Test</em> flags when a test object is constructed, and restores them
when it is destructed.</p>
<h1 id="invoking-the-tests">Invoking the Tests</h1>
<p><code>TEST()</code> and <code>TEST_F()</code> implicitly register
their tests with Google Test. So, unlike with many other C++ testing
frameworks, you don't have to re-list all your defined tests in order to
run them.</p>
<p>After defining your tests, you can run them with
<code>RUN_ALL_TESTS()</code> , which returns <code>0</code> if all the
tests are successful, or <code>1</code> otherwise. Note that
<code>RUN_ALL_TESTS()</code> runs <em>all tests</em> in your link unit
-- they can be from different test cases, or even different source
files.</p>
<p>When invoked, the <code>RUN_ALL_TESTS()</code> macro: 1. Saves the
state of all Google Test flags. 1. Creates a test fixture object for the
first test. 1. Initializes it via <code>SetUp()</code>. 1. Runs the test
on the fixture object. 1. Cleans up the fixture via
<code>TearDown()</code>. 1. Deletes the fixture. 1. Restores the state
of all Google Test flags. 1. Repeats the above steps for the next test,
until all tests have run.</p>
<p>In addition, if the text fixture's constructor generates a fatal
failure in step 2, there is no point for step 3 - 5 and they are thus
skipped. Similarly, if step 3 generates a fatal failure, step 4 will be
skipped.</p>
<p><em>Important</em>: You must not ignore the return value of
<code>RUN_ALL_TESTS()</code>, or <code>gcc</code> will give you a
compiler error. The rationale for this design is that the automated
testing service determines whether a test has passed based on its exit
code, not on its stdout/stderr output; thus your <code>main()</code>
function must return the value of <code>RUN_ALL_TESTS()</code>.</p>
<p>Also, you should call <code>RUN_ALL_TESTS()</code> only
<strong>once</strong>. Calling it more than once conflicts with some
advanced Google Test features (e.g. thread-safe death tests) and thus is
not supported.</p>
<p><em>Availability</em>: Linux, Windows, Mac.</p>
<h1 id="writing-the-main-function">Writing the main() Function</h1>
<p>You can start from this boilerplate: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;this/package/foo.h&quot;</span><br><span class="line">#include &quot;gtest/gtest.h&quot;</span><br><span class="line"></span><br><span class="line">namespace &#123;</span><br><span class="line"></span><br><span class="line">// The fixture for testing class Foo.</span><br><span class="line">class FooTest : public ::testing::Test &#123;</span><br><span class="line"> protected:</span><br><span class="line">  // You can remove any or all of the following functions if its body</span><br><span class="line">  // is empty.</span><br><span class="line"></span><br><span class="line">  FooTest() &#123;</span><br><span class="line">    // You can do set-up work for each test here.</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual ~FooTest() &#123;</span><br><span class="line">    // You can do clean-up work that doesn&#x27;t throw exceptions here.</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // If the constructor and destructor are not enough for setting up</span><br><span class="line">  // and cleaning up each test, you can define the following methods:</span><br><span class="line"></span><br><span class="line">  virtual void SetUp() &#123;</span><br><span class="line">    // Code here will be called immediately after the constructor (right</span><br><span class="line">    // before each test).</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual void TearDown() &#123;</span><br><span class="line">    // Code here will be called immediately after each test (right</span><br><span class="line">    // before the destructor).</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Objects declared here can be used by all tests in the test case for Foo.</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// Tests that the Foo::Bar() method does Abc.</span><br><span class="line">TEST_F(FooTest, MethodBarDoesAbc) &#123;</span><br><span class="line">  const string input_filepath = &quot;this/package/testdata/myinputfile.dat&quot;;</span><br><span class="line">  const string output_filepath = &quot;this/package/testdata/myoutputfile.dat&quot;;</span><br><span class="line">  Foo f;</span><br><span class="line">  EXPECT_EQ(0, f.Bar(input_filepath, output_filepath));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Tests that Foo does Xyz.</span><br><span class="line">TEST_F(FooTest, DoesXyz) &#123;</span><br><span class="line">  // Exercises the Xyz feature of Foo.</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  // namespace</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">  ::testing::InitGoogleTest(&amp;argc, argv);</span><br><span class="line">  return RUN_ALL_TESTS();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>The <code>::testing::InitGoogleTest()</code> function parses the
command line for Google Test flags, and removes all recognized flags.
This allows the user to control a test program's behavior via various
flags, which we'll cover in <a
href="AdvancedGuide.md">AdvancedGuide</a>. You must call this function
before calling <code>RUN_ALL_TESTS()</code>, or the flags won't be
properly initialized.</p>
<p>On Windows, <code>InitGoogleTest()</code> also works with wide
strings, so it can be used in programs compiled in <code>UNICODE</code>
mode as well.</p>
<p>But maybe you think that writing all those main() functions is too
much work? We agree with you completely and that's why Google Test
provides a basic implementation of main(). If it fits your needs, then
just link your test with gtest_main library and you are good to go.</p>
<h2 id="important-note-for-visual-c-users">Important note for Visual C++
users</h2>
<p>If you put your tests into a library and your <code>main()</code>
function is in a different library or in your .exe file, those tests
will not run. The reason is a <a
target="_blank" rel="noopener" href="https://connect.microsoft.com/feedback/viewfeedback.aspx?FeedbackID=244410&amp;siteid=210">bug</a>
in Visual C++. When you define your tests, Google Test creates certain
static objects to register them. These objects are not referenced from
elsewhere but their constructors are still supposed to run. When Visual
C++ linker sees that nothing in the library is referenced from other
places it throws the library out. You have to reference your library
with tests from your main program to keep the linker from discarding it.
Here is how to do it. Somewhere in your library code declare a function:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__declspec(dllexport) int PullInMyLibrary() &#123; return 0; &#125;</span><br></pre></td></tr></table></figure> If you put your tests in a static library (not DLL) then
<code>__declspec(dllexport)</code> is not required. Now, in your main
program, write a code that invokes that function: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int PullInMyLibrary();</span><br><span class="line">static int dummy = PullInMyLibrary();</span><br></pre></td></tr></table></figure> This
will keep your tests referenced and will make them register themselves
at startup.</p>
<p>In addition, if you define your tests in a static library, add
<code>/OPT:NOREF</code> to your main program linker options. If you use
MSVC++ IDE, go to your .exe project properties/Configuration
Properties/Linker/Optimization and set References setting to
<code>Keep Unreferenced Data (/OPT:NOREF)</code>. This will keep Visual
C++ linker from discarding individual symbols generated by your tests
from the final executable.</p>
<p>There is one more pitfall, though. If you use Google Test as a static
library (that's how it is defined in gtest.vcproj) your tests must also
reside in a static library. If you have to have them in a DLL, you
<em>must</em> change Google Test to build into a DLL as well. Otherwise
your tests will not run correctly or will not run at all. The general
conclusion here is: make your life easier - do not write your tests in
libraries!</p>
<h1 id="where-to-go-from-here">Where to Go from Here</h1>
<p>Congratulations! You've learned the Google Test basics. You can start
writing and running Google Test tests, read some <a
href="Samples.md">samples</a>, or continue with <a
href="AdvancedGuide.md">AdvancedGuide</a>, which describes many more
useful Google Test features.</p>
<h1 id="known-limitations">Known Limitations</h1>
<p>Google Test is designed to be thread-safe. The implementation is
thread-safe on systems where the <code>pthreads</code> library is
available. It is currently <em>unsafe</em> to use Google Test assertions
from two threads concurrently on other systems (e.g. Windows). In most
tests this is not an issue as usually the assertions are done in the
main thread. If you want to help, you can volunteer to implement the
necessary synchronization primitives in <code>gtest-port.h</code> for
your platform.</p>
<p>Now that you have read <a href="Primer.md">Primer</a> and learned how
to write tests using Google Test, it's time to learn some new tricks.
This document will show you more assertions as well as how to construct
complex failure messages, propagate fatal failures, reuse and speed up
your test fixtures, and use various flags with your tests.</p>
<h1 id="more-assertions">More Assertions</h1>
<p>This section covers some less frequently used, but still significant,
assertions.</p>
<h2 id="explicit-success-and-failure">Explicit Success and Failure</h2>
<p>These three assertions do not actually test a value or expression.
Instead, they generate a success or failure directly. Like the macros
that actually perform a test, you may stream a custom failure message
into the them.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"><code>SUCCEED();</code></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>Generates a success. This does NOT make the overall test succeed. A
test is considered successful only if none of its assertions fail during
its execution.</p>
<p>Note: <code>SUCCEED()</code> is purely documentary and currently
doesn't generate any user-visible output. However, we may add
<code>SUCCEED()</code> messages to Google Test's output in the
future.</p>
<table>
<colgroup>
<col style="width: 14%" />
<col style="width: 21%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><code>FAIL();</code></th>
<th style="text-align: left;"><code>ADD_FAILURE();</code></th>
<th
style="text-align: left;"><code>ADD_FAILURE_AT("</code><em>file_path</em><code>",</code><em>line_number</em><code>);</code></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p><code>FAIL()</code> generates a fatal failure, while
<code>ADD_FAILURE()</code> and <code>ADD_FAILURE_AT()</code> generate a
nonfatal failure. These are useful when control flow, rather than a
Boolean expression, deteremines the test's success or failure. For
example, you might want to write something like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">switch(expression) &#123;</span><br><span class="line">  case 1: ... some checks ...</span><br><span class="line">  case 2: ... some other checks</span><br><span class="line">  ...</span><br><span class="line">  default: FAIL() &lt;&lt; &quot;We shouldn&#x27;t get here.&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note: you can only use <code>FAIL()</code> in functions that return
<code>void</code>. See the <a href="#assertion-placement">Assertion
Placement section</a> for more information.</p>
<p><em>Availability</em>: Linux, Windows, Mac.</p>
<h2 id="exception-assertions">Exception Assertions</h2>
<p>These are for verifying that a piece of code throws (or does not
throw) an exception of the given type:</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 40%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Fatal assertion</strong></th>
<th style="text-align: left;"><strong>Nonfatal assertion</strong></th>
<th style="text-align: left;"><strong>Verifies</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td
style="text-align: left;"><code>ASSERT_THROW(</code><em>statement</em>,
<em>exception_type</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_THROW(</code><em>statement</em>,
<em>exception_type</em><code>);</code></td>
<td style="text-align: left;"><em>statement</em> throws an exception of
the given type</td>
</tr>
<tr class="even">
<td
style="text-align: left;"><code>ASSERT_ANY_THROW(</code><em>statement</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_ANY_THROW(</code><em>statement</em><code>);</code></td>
<td style="text-align: left;"><em>statement</em> throws an exception of
any type</td>
</tr>
<tr class="odd">
<td
style="text-align: left;"><code>ASSERT_NO_THROW(</code><em>statement</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_NO_THROW(</code><em>statement</em><code>);</code></td>
<td style="text-align: left;"><em>statement</em> doesn't throw any
exception</td>
</tr>
</tbody>
</table>
<p>Examples:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ASSERT_THROW(Foo(5), bar_exception);</span><br><span class="line"></span><br><span class="line">EXPECT_NO_THROW(&#123;</span><br><span class="line">  int n = 5;</span><br><span class="line">  Bar(&amp;n);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><em>Availability</em>: Linux, Windows, Mac; since version 1.1.0.</p>
<h2 id="predicate-assertions-for-better-error-messages">Predicate
Assertions for Better Error Messages</h2>
<p>Even though Google Test has a rich set of assertions, they can never
be complete, as it's impossible (nor a good idea) to anticipate all the
scenarios a user might run into. Therefore, sometimes a user has to use
<code>EXPECT_TRUE()</code> to check a complex expression, for lack of a
better macro. This has the problem of not showing you the values of the
parts of the expression, making it hard to understand what went wrong.
As a workaround, some users choose to construct the failure message by
themselves, streaming it into <code>EXPECT_TRUE()</code>. However, this
is awkward especially when the expression has side-effects or is
expensive to evaluate.</p>
<p>Google Test gives you three different options to solve this
problem:</p>
<h3 id="using-an-existing-boolean-function">Using an Existing Boolean
Function</h3>
<p>If you already have a function or a functor that returns
<code>bool</code> (or a type that can be implicitly converted to
<code>bool</code>), you can use it in a <em>predicate assertion</em> to
get the function arguments printed for free:</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 40%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Fatal assertion</strong></th>
<th style="text-align: left;"><strong>Nonfatal assertion</strong></th>
<th style="text-align: left;"><strong>Verifies</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>ASSERT_PRED1(</code><em>pred1,
val1</em><code>);</code></td>
<td style="text-align: left;"><code>EXPECT_PRED1(</code><em>pred1,
val1</em><code>);</code></td>
<td style="text-align: left;"><em>pred1(val1)</em> returns true</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ASSERT_PRED2(</code><em>pred2, val1,
val2</em><code>);</code></td>
<td style="text-align: left;"><code>EXPECT_PRED2(</code><em>pred2, val1,
val2</em><code>);</code></td>
<td style="text-align: left;"><em>pred2(val1, val2)</em> returns
true</td>
</tr>
<tr class="odd">
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
<td style="text-align: left;">...</td>
</tr>
</tbody>
</table>
<p>In the above, <em>predn</em> is an <em>n</em>-ary predicate function
or functor, where <em>val1</em>, <em>val2</em>, ..., and <em>valn</em>
are its arguments. The assertion succeeds if the predicate returns
<code>true</code> when applied to the given arguments, and fails
otherwise. When the assertion fails, it prints the value of each
argument. In either case, the arguments are evaluated exactly once.</p>
<p>Here's an example. Given</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Returns true iff m and n have no common divisors except 1.</span><br><span class="line">bool MutuallyPrime(int m, int n) &#123; ... &#125;</span><br><span class="line">const int a = 3;</span><br><span class="line">const int b = 4;</span><br><span class="line">const int c = 10;</span><br></pre></td></tr></table></figure>
<p>the assertion <code>EXPECT_PRED2(MutuallyPrime, a, b);</code> will
succeed, while the assertion
<code>EXPECT_PRED2(MutuallyPrime, b, c);</code> will fail with the
message</p>
<pre>
!MutuallyPrime(b, c) is false, where<br>
b is 4<br>
c is 10<br>
</pre>
<p><strong>Notes:</strong></p>
<ol type="1">
<li>If you see a compiler error "no matching function to call" when
using <code>ASSERT_PRED*</code> or <code>EXPECT_PRED*</code>, please see
<a
href="FAQ.md#the-compiler-complains-no-matching-function-to-call-when-i-use-assert_predn-how-do-i-fix-it">this
FAQ</a> for how to resolve it.</li>
<li>Currently we only provide predicate assertions of arity &lt;= 5. If
you need a higher-arity assertion, let us know.</li>
</ol>
<p><em>Availability</em>: Linux, Windows, Mac</p>
<h3 id="using-a-function-that-returns-an-assertionresult">Using a
Function That Returns an AssertionResult</h3>
<p>While <code>EXPECT_PRED*()</code> and friends are handy for a quick
job, the syntax is not satisfactory: you have to use different macros
for different arities, and it feels more like Lisp than C++. The
<code>::testing::AssertionResult</code> class solves this problem.</p>
<p>An <code>AssertionResult</code> object represents the result of an
assertion (whether it's a success or a failure, and an associated
message). You can create an <code>AssertionResult</code> using one of
these factory functions:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">namespace testing &#123;</span><br><span class="line"></span><br><span class="line">// Returns an AssertionResult object to indicate that an assertion has</span><br><span class="line">// succeeded.</span><br><span class="line">AssertionResult AssertionSuccess();</span><br><span class="line"></span><br><span class="line">// Returns an AssertionResult object to indicate that an assertion has</span><br><span class="line">// failed.</span><br><span class="line">AssertionResult AssertionFailure();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can then use the <code>&lt;&lt;</code> operator to stream
messages to the <code>AssertionResult</code> object.</p>
<p>To provide more readable messages in Boolean assertions (e.g.
<code>EXPECT_TRUE()</code>), write a predicate function that returns
<code>AssertionResult</code> instead of <code>bool</code>. For example,
if you define <code>IsEven()</code> as:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">::testing::AssertionResult IsEven(int n) &#123;</span><br><span class="line">  if ((n % 2) == 0)</span><br><span class="line">    return ::testing::AssertionSuccess();</span><br><span class="line">  else</span><br><span class="line">    return ::testing::AssertionFailure() &lt;&lt; n &lt;&lt; &quot; is odd&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>instead of:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bool IsEven(int n) &#123;</span><br><span class="line">  return (n % 2) == 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>the failed assertion <code>EXPECT_TRUE(IsEven(Fib(4)))</code> will
print:</p>
<pre>
Value of: IsEven(Fib(4))<br>
Actual: false (*3 is odd*)<br>
Expected: true<br>
</pre>
<p>instead of a more opaque</p>
<pre>
Value of: IsEven(Fib(4))<br>
Actual: false<br>
Expected: true<br>
</pre>
<p>If you want informative messages in <code>EXPECT_FALSE</code> and
<code>ASSERT_FALSE</code> as well, and are fine with making the
predicate slower in the success case, you can supply a success
message:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">::testing::AssertionResult IsEven(int n) &#123;</span><br><span class="line">  if ((n % 2) == 0)</span><br><span class="line">    return ::testing::AssertionSuccess() &lt;&lt; n &lt;&lt; &quot; is even&quot;;</span><br><span class="line">  else</span><br><span class="line">    return ::testing::AssertionFailure() &lt;&lt; n &lt;&lt; &quot; is odd&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then the statement <code>EXPECT_FALSE(IsEven(Fib(6)))</code> will
print</p>
<pre>
Value of: IsEven(Fib(6))<br>
Actual: true (8 is even)<br>
Expected: false<br>
</pre>
<p><em>Availability</em>: Linux, Windows, Mac; since version 1.4.1.</p>
<h3 id="using-a-predicate-formatter">Using a Predicate-Formatter</h3>
<p>If you find the default message generated by
<code>(ASSERT|EXPECT)_PRED*</code> and
<code>(ASSERT|EXPECT)_(TRUE|FALSE)</code> unsatisfactory, or some
arguments to your predicate do not support streaming to
<code>ostream</code>, you can instead use the following
<em>predicate-formatter assertions</em> to <em>fully</em> customize how
the message is formatted:</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 40%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Fatal assertion</strong></th>
<th style="text-align: left;"><strong>Nonfatal assertion</strong></th>
<th style="text-align: left;"><strong>Verifies</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td
style="text-align: left;"><code>ASSERT_PRED_FORMAT1(</code><em>pred_format1,
val1</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_PRED_FORMAT1(</code><em>pred_format1,
val1</em><code>);</code></td>
<td style="text-align: left;"><em>pred_format1(val1)</em> is
successful</td>
</tr>
<tr class="even">
<td
style="text-align: left;"><code>ASSERT_PRED_FORMAT2(</code><em>pred_format2,
val1, val2</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_PRED_FORMAT2(</code><em>pred_format2,
val1, val2</em><code>);</code></td>
<td style="text-align: left;"><em>pred_format2(val1, val2)</em> is
successful</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>...</code></td>
<td style="text-align: left;"><code>...</code></td>
<td style="text-align: left;"><code>...</code></td>
</tr>
</tbody>
</table>
<p>The difference between this and the previous two groups of macros is
that instead of a predicate, <code>(ASSERT|EXPECT)_PRED_FORMAT*</code>
take a <em>predicate-formatter</em> (<em>pred_formatn</em>), which is a
function or functor with the signature:</p>
<p><code>::testing::AssertionResult PredicateFormattern(const char*</code><em>expr1</em><code>, const char*</code><em>expr2</em><code>, ... const char*</code><em>exprn</em><code>, T1</code><em>val1</em><code>, T2</code><em>val2</em><code>, ... Tn</code><em>valn</em><code>);</code></p>
<p>where <em>val1</em>, <em>val2</em>, ..., and <em>valn</em> are the
values of the predicate arguments, and <em>expr1</em>, <em>expr2</em>,
..., and <em>exprn</em> are the corresponding expressions as they appear
in the source code. The types <code>T1</code>, <code>T2</code>, ..., and
<code>Tn</code> can be either value types or reference types. For
example, if an argument has type <code>Foo</code>, you can declare it as
either <code>Foo</code> or <code>const Foo&amp;</code>, whichever is
appropriate.</p>
<p>A predicate-formatter returns a
<code>::testing::AssertionResult</code> object to indicate whether the
assertion has succeeded or not. The only way to create such an object is
to call one of these factory functions:</p>
<p>As an example, let's improve the failure message in the previous
example, which uses <code>EXPECT_PRED2()</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// Returns the smallest prime common divisor of m and n,</span><br><span class="line">// or 1 when m and n are mutually prime.</span><br><span class="line">int SmallestPrimeCommonDivisor(int m, int n) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">// A predicate-formatter for asserting that two integers are mutually prime.</span><br><span class="line">::testing::AssertionResult AssertMutuallyPrime(const char* m_expr,</span><br><span class="line">                                               const char* n_expr,</span><br><span class="line">                                               int m,</span><br><span class="line">                                               int n) &#123;</span><br><span class="line">  if (MutuallyPrime(m, n))</span><br><span class="line">    return ::testing::AssertionSuccess();</span><br><span class="line"></span><br><span class="line">  return ::testing::AssertionFailure()</span><br><span class="line">      &lt;&lt; m_expr &lt;&lt; &quot; and &quot; &lt;&lt; n_expr &lt;&lt; &quot; (&quot; &lt;&lt; m &lt;&lt; &quot; and &quot; &lt;&lt; n</span><br><span class="line">      &lt;&lt; &quot;) are not mutually prime, &quot; &lt;&lt; &quot;as they have a common divisor &quot;</span><br><span class="line">      &lt;&lt; SmallestPrimeCommonDivisor(m, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With this predicate-formatter, we can use</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPECT_PRED_FORMAT2(AssertMutuallyPrime, b, c);</span><br></pre></td></tr></table></figure>
<p>to generate the message</p>
<pre>
b and c (4 and 10) are not mutually prime, as they have a common divisor 2.<br>
</pre>
<p>As you may have realized, many of the assertions we introduced
earlier are special cases of <code>(EXPECT|ASSERT)_PRED_FORMAT*</code>.
In fact, most of them are indeed defined using
<code>(EXPECT|ASSERT)_PRED_FORMAT*</code>.</p>
<p><em>Availability</em>: Linux, Windows, Mac.</p>
<h2 id="floating-point-comparison">Floating-Point Comparison</h2>
<p>Comparing floating-point numbers is tricky. Due to round-off errors,
it is very unlikely that two floating-points will match exactly.
Therefore, <code>ASSERT_EQ</code> 's naive comparison usually doesn't
work. And since floating-points can have a wide value range, no single
fixed error bound works. It's better to compare by a fixed relative
error bound, except for values close to 0 due to the loss of precision
there.</p>
<p>In general, for floating-point comparison to make sense, the user
needs to carefully choose the error bound. If they don't want or care
to, comparing in terms of Units in the Last Place (ULPs) is a good
default, and Google Test provides assertions to do this. Full details
about ULPs are quite long; if you want to learn more, see <a
target="_blank" rel="noopener" href="http://www.cygnus-software.com/papers/comparingfloats/comparingfloats.htm">this
article on float comparison</a>.</p>
<h3 id="floating-point-macros">Floating-Point Macros</h3>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 40%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Fatal assertion</strong></th>
<th style="text-align: left;"><strong>Nonfatal assertion</strong></th>
<th style="text-align: left;"><strong>Verifies</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>ASSERT_FLOAT_EQ(</code><em>val1,
val2</em><code>);</code></td>
<td style="text-align: left;"><code>EXPECT_FLOAT_EQ(</code><em>val1,
val2</em><code>);</code></td>
<td style="text-align: left;">the two <code>float</code> values are
almost equal</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ASSERT_DOUBLE_EQ(</code><em>val1,
val2</em><code>);</code></td>
<td style="text-align: left;"><code>EXPECT_DOUBLE_EQ(</code><em>val1,
val2</em><code>);</code></td>
<td style="text-align: left;">the two <code>double</code> values are
almost equal</td>
</tr>
</tbody>
</table>
<p>By "almost equal", we mean the two values are within 4 ULP's from
each other.</p>
<p>The following assertions allow you to choose the acceptable error
bound:</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 40%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Fatal assertion</strong></th>
<th style="text-align: left;"><strong>Nonfatal assertion</strong></th>
<th style="text-align: left;"><strong>Verifies</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>ASSERT_NEAR(</code><em>val1, val2,
abs_error</em><code>);</code></td>
<td style="text-align: left;"><code>EXPECT_NEAR</code><em>(val1, val2,
abs_error</em><code>);</code></td>
<td style="text-align: left;">the difference between <em>val1</em> and
<em>val2</em> doesn't exceed the given absolute error</td>
</tr>
</tbody>
</table>
<p><em>Availability</em>: Linux, Windows, Mac.</p>
<h3 id="floating-point-predicate-format-functions">Floating-Point
Predicate-Format Functions</h3>
<p>Some floating-point operations are useful, but not that often used.
In order to avoid an explosion of new macros, we provide them as
predicate-format functions that can be used in predicate assertion
macros (e.g. <code>EXPECT_PRED_FORMAT2</code>, etc).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EXPECT_PRED_FORMAT2(::testing::FloatLE, val1, val2);</span><br><span class="line">EXPECT_PRED_FORMAT2(::testing::DoubleLE, val1, val2);</span><br></pre></td></tr></table></figure>
<p>Verifies that <em>val1</em> is less than, or almost equal to,
<em>val2</em>. You can replace <code>EXPECT_PRED_FORMAT2</code> in the
above table with <code>ASSERT_PRED_FORMAT2</code>.</p>
<p><em>Availability</em>: Linux, Windows, Mac.</p>
<h2 id="windows-hresult-assertions">Windows HRESULT assertions</h2>
<p>These assertions test for <code>HRESULT</code> success or
failure.</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 40%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Fatal assertion</strong></th>
<th style="text-align: left;"><strong>Nonfatal assertion</strong></th>
<th style="text-align: left;"><strong>Verifies</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td
style="text-align: left;"><code>ASSERT_HRESULT_SUCCEEDED(</code><em>expression</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_HRESULT_SUCCEEDED(</code><em>expression</em><code>);</code></td>
<td style="text-align: left;"><em>expression</em> is a success
<code>HRESULT</code></td>
</tr>
<tr class="even">
<td
style="text-align: left;"><code>ASSERT_HRESULT_FAILED(</code><em>expression</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_HRESULT_FAILED(</code><em>expression</em><code>);</code></td>
<td style="text-align: left;"><em>expression</em> is a failure
<code>HRESULT</code></td>
</tr>
</tbody>
</table>
<p>The generated output contains the human-readable error message
associated with the <code>HRESULT</code> code returned by
<em>expression</em>.</p>
<p>You might use them like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CComPtr shell;</span><br><span class="line">ASSERT_HRESULT_SUCCEEDED(shell.CoCreateInstance(L&quot;Shell.Application&quot;));</span><br><span class="line">CComVariant empty;</span><br><span class="line">ASSERT_HRESULT_SUCCEEDED(shell-&gt;ShellExecute(CComBSTR(url), empty, empty, empty, empty));</span><br></pre></td></tr></table></figure>
<p><em>Availability</em>: Windows.</p>
<h2 id="type-assertions">Type Assertions</h2>
<p>You can call the function <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">::testing::StaticAssertTypeEq&lt;T1, T2&gt;();</span><br></pre></td></tr></table></figure> to assert that types
<code>T1</code> and <code>T2</code> are the same. The function does
nothing if the assertion is satisfied. If the types are different, the
function call will fail to compile, and the compiler error message will
likely (depending on the compiler) show you the actual values of
<code>T1</code> and <code>T2</code>. This is mainly useful inside
template code.</p>
<p><em>Caveat:</em> When used inside a member function of a class
template or a function template,
<code>StaticAssertTypeEq&lt;T1, T2&gt;()</code> is effective <em>only
if</em> the function is instantiated. For example, given: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">template &lt;typename T&gt; class Foo &#123;</span><br><span class="line"> public:</span><br><span class="line">  void Bar() &#123; ::testing::StaticAssertTypeEq&lt;int, T&gt;(); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
the code: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void Test1() &#123; Foo&lt;bool&gt; foo; &#125;</span><br></pre></td></tr></table></figure> will <em>not</em> generate a compiler error, as
<code>Foo&lt;bool&gt;::Bar()</code> is never actually instantiated.
Instead, you need: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void Test2() &#123; Foo&lt;bool&gt; foo; foo.Bar(); &#125;</span><br></pre></td></tr></table></figure> to cause a compiler error.</p>
<p><em>Availability:</em> Linux, Windows, Mac; since version 1.3.0.</p>
<h2 id="assertion-placement">Assertion Placement</h2>
<p>You can use assertions in any C++ function. In particular, it doesn't
have to be a method of the test fixture class. The one constraint is
that assertions that generate a fatal failure (<code>FAIL*</code> and
<code>ASSERT_*</code>) can only be used in void-returning functions.
This is a consequence of Google Test not using exceptions. By placing it
in a non-void function you'll get a confusing compile error like
<code>"error: void value not ignored as it ought to be"</code>.</p>
<p>If you need to use assertions in a function that returns non-void,
one option is to make the function return the value in an out parameter
instead. For example, you can rewrite <code>T2 Foo(T1 x)</code> to
<code>void Foo(T1 x, T2* result)</code>. You need to make sure that
<code>*result</code> contains some sensible value even when the function
returns prematurely. As the function now returns <code>void</code>, you
can use any assertion inside of it.</p>
<p>If changing the function's type is not an option, you should just use
assertions that generate non-fatal failures, such as
<code>ADD_FAILURE*</code> and <code>EXPECT_*</code>.</p>
<p><em>Note</em>: Constructors and destructors are not considered
void-returning functions, according to the C++ language specification,
and so you may not use fatal assertions in them. You'll get a
compilation error if you try. A simple workaround is to transfer the
entire body of the constructor or destructor to a private void-returning
method. However, you should be aware that a fatal assertion failure in a
constructor does not terminate the current test, as your intuition might
suggest; it merely returns from the constructor early, possibly leaving
your object in a partially-constructed state. Likewise, a fatal
assertion failure in a destructor may leave your object in a
partially-destructed state. Use assertions carefully in these
situations!</p>
<h1 id="teaching-google-test-how-to-print-your-values">Teaching Google
Test How to Print Your Values</h1>
<p>When a test assertion such as <code>EXPECT_EQ</code> fails, Google
Test prints the argument values to help you debug. It does this using a
user-extensible value printer.</p>
<p>This printer knows how to print built-in C++ types, native arrays,
STL containers, and any type that supports the <code>&lt;&lt;</code>
operator. For other types, it prints the raw bytes in the value and
hopes that you the user can figure it out.</p>
<p>As mentioned earlier, the printer is <em>extensible</em>. That means
you can teach it to do a better job at printing your particular type
than to dump the bytes. To do that, define <code>&lt;&lt;</code> for
your type:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">namespace foo &#123;</span><br><span class="line"></span><br><span class="line">class Bar &#123; ... &#125;;  // We want Google Test to be able to print instances of this.</span><br><span class="line"></span><br><span class="line">// It&#x27;s important that the &lt;&lt; operator is defined in the SAME</span><br><span class="line">// namespace that defines Bar.  C++&#x27;s look-up rules rely on that.</span><br><span class="line">::std::ostream&amp; operator&lt;&lt;(::std::ostream&amp; os, const Bar&amp; bar) &#123;</span><br><span class="line">  return os &lt;&lt; bar.DebugString();  // whatever needed to print bar to os</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  // namespace foo</span><br></pre></td></tr></table></figure>
<p>Sometimes, this might not be an option: your team may consider it bad
style to have a <code>&lt;&lt;</code> operator for <code>Bar</code>, or
<code>Bar</code> may already have a <code>&lt;&lt;</code> operator that
doesn't do what you want (and you cannot change it). If so, you can
instead define a <code>PrintTo()</code> function like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">namespace foo &#123;</span><br><span class="line"></span><br><span class="line">class Bar &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line">// It&#x27;s important that PrintTo() is defined in the SAME</span><br><span class="line">// namespace that defines Bar.  C++&#x27;s look-up rules rely on that.</span><br><span class="line">void PrintTo(const Bar&amp; bar, ::std::ostream* os) &#123;</span><br><span class="line">  *os &lt;&lt; bar.DebugString();  // whatever needed to print bar to os</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;  // namespace foo</span><br></pre></td></tr></table></figure>
<p>If you have defined both <code>&lt;&lt;</code> and
<code>PrintTo()</code>, the latter will be used when Google Test is
concerned. This allows you to customize how the value appears in Google
Test's output without affecting code that relies on the behavior of its
<code>&lt;&lt;</code> operator.</p>
<p>If you want to print a value <code>x</code> using Google Test's value
printer yourself, just call
<code>::testing::PrintToString(</code><em>x</em><code>)</code>, which
returns an <code>std::string</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;pair&lt;Bar, int&gt; &gt; bar_ints = GetBarIntVector();</span><br><span class="line"></span><br><span class="line">EXPECT_TRUE(IsCorrectBarIntVector(bar_ints))</span><br><span class="line">    &lt;&lt; &quot;bar_ints = &quot; &lt;&lt; ::testing::PrintToString(bar_ints);</span><br></pre></td></tr></table></figure>
<h1 id="death-tests">Death Tests</h1>
<p>In many applications, there are assertions that can cause application
failure if a condition is not met. These sanity checks, which ensure
that the program is in a known good state, are there to fail at the
earliest possible time after some program state is corrupted. If the
assertion checks the wrong condition, then the program may proceed in an
erroneous state, which could lead to memory corruption, security holes,
or worse. Hence it is vitally important to test that such assertion
statements work as expected.</p>
<p>Since these precondition checks cause the processes to die, we call
such tests <em>death tests</em>. More generally, any test that checks
that a program terminates (except by throwing an exception) in an
expected fashion is also a death test.</p>
<p>Note that if a piece of code throws an exception, we don't consider
it "death" for the purpose of death tests, as the caller of the code
could catch the exception and avoid the crash. If you want to verify
exceptions thrown by your code, see <a
href="#exception-assertions">Exception Assertions</a>.</p>
<p>If you want to test <code>EXPECT_*()/ASSERT_*()</code> failures in
your test code, see <a href="#catching-failures">Catching
Failures</a>.</p>
<h2 id="how-to-write-a-death-test">How to Write a Death Test</h2>
<p>Google Test has the following macros to support death tests:</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 40%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Fatal assertion</strong></th>
<th style="text-align: left;"><strong>Nonfatal assertion</strong></th>
<th style="text-align: left;"><strong>Verifies</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>ASSERT_DEATH(</code><em>statement,
regex</em><code>);</code></td>
<td style="text-align: left;"><code>EXPECT_DEATH(</code><em>statement,
regex</em><code>);</code></td>
<td style="text-align: left;"><em>statement</em> crashes with the given
error</td>
</tr>
<tr class="even">
<td
style="text-align: left;"><code>ASSERT_DEATH_IF_SUPPORTED(</code><em>statement,
regex</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_DEATH_IF_SUPPORTED(</code><em>statement,
regex</em><code>);</code></td>
<td style="text-align: left;">if death tests are supported, verifies
that <em>statement</em> crashes with the given error; otherwise verifies
nothing</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>ASSERT_EXIT(</code><em>statement,
predicate, regex</em><code>);</code></td>
<td style="text-align: left;"><code>EXPECT_EXIT(</code><em>statement,
predicate, regex</em><code>);</code></td>
<td style="text-align: left;"><em>statement</em> exits with the given
error and its exit code matches <em>predicate</em></td>
</tr>
</tbody>
</table>
<p>where <em>statement</em> is a statement that is expected to cause the
process to die, <em>predicate</em> is a function or function object that
evaluates an integer exit status, and <em>regex</em> is a regular
expression that the stderr output of <em>statement</em> is expected to
match. Note that <em>statement</em> can be <em>any valid statement</em>
(including <em>compound statement</em>) and doesn't have to be an
expression.</p>
<p>As usual, the <code>ASSERT</code> variants abort the current test
function, while the <code>EXPECT</code> variants do not.</p>
<p><strong>Note:</strong> We use the word "crash" here to mean that the
process terminates with a <em>non-zero</em> exit status code. There are
two possibilities: either the process has called <code>exit()</code> or
<code>_exit()</code> with a non-zero value, or it may be killed by a
signal.</p>
<p>This means that if <em>statement</em> terminates the process with a 0
exit code, it is <em>not</em> considered a crash by
<code>EXPECT_DEATH</code>. Use <code>EXPECT_EXIT</code> instead if this
is the case, or if you want to restrict the exit code more
precisely.</p>
<p>A predicate here must accept an <code>int</code> and return a
<code>bool</code>. The death test succeeds only if the predicate returns
<code>true</code>. Google Test defines a few predicates that handle the
most common cases:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">::testing::ExitedWithCode(exit_code)</span><br></pre></td></tr></table></figure>
<p>This expression is <code>true</code> if the program exited normally
with the given exit code.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">::testing::KilledBySignal(signal_number)  // Not available on Windows.</span><br></pre></td></tr></table></figure>
<p>This expression is <code>true</code> if the program was killed by the
given signal.</p>
<p>The <code>*_DEATH</code> macros are convenient wrappers for
<code>*_EXIT</code> that use a predicate that verifies the process' exit
code is non-zero.</p>
<p>Note that a death test only cares about three things:</p>
<ol type="1">
<li>does <em>statement</em> abort or exit the process?</li>
<li>(in the case of <code>ASSERT_EXIT</code> and
<code>EXPECT_EXIT</code>) does the exit status satisfy
<em>predicate</em>? Or (in the case of <code>ASSERT_DEATH</code> and
<code>EXPECT_DEATH</code>) is the exit status non-zero? And</li>
<li>does the stderr output match <em>regex</em>?</li>
</ol>
<p>In particular, if <em>statement</em> generates an
<code>ASSERT_*</code> or <code>EXPECT_*</code> failure, it will
<strong>not</strong> cause the death test to fail, as Google Test
assertions don't abort the process.</p>
<p>To write a death test, simply use one of the above macros inside your
test function. For example,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">TEST(MyDeathTest, Foo) &#123;</span><br><span class="line">  // This death test uses a compound statement.</span><br><span class="line">  ASSERT_DEATH(&#123; int n = 5; Foo(&amp;n); &#125;, &quot;Error on line .* of Foo()&quot;);</span><br><span class="line">&#125;</span><br><span class="line">TEST(MyDeathTest, NormalExit) &#123;</span><br><span class="line">  EXPECT_EXIT(NormalExit(), ::testing::ExitedWithCode(0), &quot;Success&quot;);</span><br><span class="line">&#125;</span><br><span class="line">TEST(MyDeathTest, KillMyself) &#123;</span><br><span class="line">  EXPECT_EXIT(KillMyself(), ::testing::KilledBySignal(SIGKILL), &quot;Sending myself unblockable signal&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>verifies that:</p>
<ul>
<li>calling <code>Foo(5)</code> causes the process to die with the given
error message,</li>
<li>calling <code>NormalExit()</code> causes the process to print
<code>"Success"</code> to stderr and exit with exit code 0, and</li>
<li>calling <code>KillMyself()</code> kills the process with signal
<code>SIGKILL</code>.</li>
</ul>
<p>The test function body may contain other assertions and statements as
well, if necessary.</p>
<p><em>Important:</em> We strongly recommend you to follow the
convention of naming your test case (not test) <code>*DeathTest</code>
when it contains a death test, as demonstrated in the above example. The
<code>Death Tests And Threads</code> section below explains why.</p>
<p>If a test fixture class is shared by normal tests and death tests,
you can use typedef to introduce an alias for the fixture class and
avoid duplicating its code: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class FooTest : public ::testing::Test &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line">typedef FooTest FooDeathTest;</span><br><span class="line"></span><br><span class="line">TEST_F(FooTest, DoesThis) &#123;</span><br><span class="line">  // normal test</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST_F(FooDeathTest, DoesThat) &#123;</span><br><span class="line">  // death test</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>Availability:</em> Linux, Windows (requires MSVC 8.0 or above),
Cygwin, and Mac (the latter three are supported since v1.3.0).
<code>(ASSERT|EXPECT)_DEATH_IF_SUPPORTED</code> are new in v1.4.0.</p>
<h2 id="regular-expression-syntax">Regular Expression Syntax</h2>
<p>On POSIX systems (e.g. Linux, Cygwin, and Mac), Google Test uses the
<a
target="_blank" rel="noopener" href="http://www.opengroup.org/onlinepubs/009695399/basedefs/xbd_chap09.html#tag_09_04">POSIX
extended regular expression</a> syntax in death tests. To learn about
this syntax, you may want to read this <a
target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Regular_expression#POSIX_Extended_Regular_Expressions">Wikipedia
entry</a>.</p>
<p>On Windows, Google Test uses its own simple regular expression
implementation. It lacks many features you can find in POSIX extended
regular expressions. For example, we don't support union
(<code>"x|y"</code>), grouping (<code>"(xy)"</code>), brackets
(<code>"[xy]"</code>), and repetition count (<code>"x&#123;5,7&#125;"</code>),
among others. Below is what we do support (Letter <code>A</code> denotes
a literal character, period (<code>.</code>), or a single
<code>\\</code> escape sequence; <code>x</code> and <code>y</code>
denote regular expressions.):</p>
<table>
<colgroup>
<col style="width: 12%" />
<col style="width: 87%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><code>c</code></th>
<th style="text-align: left;">matches any literal character
<code>c</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>\\d</code></td>
<td style="text-align: left;">matches any decimal digit</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>\\D</code></td>
<td style="text-align: left;">matches any character that's not a decimal
digit</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>\\f</code></td>
<td style="text-align: left;">matches <code>\f</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>\\n</code></td>
<td style="text-align: left;">matches <code>\n</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>\\r</code></td>
<td style="text-align: left;">matches <code>\r</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>\\s</code></td>
<td style="text-align: left;">matches any ASCII whitespace, including
<code>\n</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>\\S</code></td>
<td style="text-align: left;">matches any character that's not a
whitespace</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>\\t</code></td>
<td style="text-align: left;">matches <code>\t</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>\\v</code></td>
<td style="text-align: left;">matches <code>\v</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>\\w</code></td>
<td style="text-align: left;">matches any letter, <code>_</code>, or
decimal digit</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>\\W</code></td>
<td style="text-align: left;">matches any character that
<code>\\w</code> doesn't match</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>\\c</code></td>
<td style="text-align: left;">matches any literal character
<code>c</code>, which must be a punctuation</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>\\.</code></td>
<td style="text-align: left;">matches the <code>.</code> character</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>.</code></td>
<td style="text-align: left;">matches any single character except
<code>\n</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>A?</code></td>
<td style="text-align: left;">matches 0 or 1 occurrences of
<code>A</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>A*</code></td>
<td style="text-align: left;">matches 0 or many occurrences of
<code>A</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>A+</code></td>
<td style="text-align: left;">matches 1 or many occurrences of
<code>A</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>^</code></td>
<td style="text-align: left;">matches the beginning of a string (not
that of each line)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>$</code></td>
<td style="text-align: left;">matches the end of a string (not that of
each line)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>xy</code></td>
<td style="text-align: left;">matches <code>x</code> followed by
<code>y</code></td>
</tr>
</tbody>
</table>
<p>To help you determine which capability is available on your system,
Google Test defines macro <code>GTEST_USES_POSIX_RE=1</code> when it
uses POSIX extended regular expressions, or
<code>GTEST_USES_SIMPLE_RE=1</code> when it uses the simple version. If
you want your death tests to work in both cases, you can either
<code>#if</code> on these macros or use the more limited syntax
only.</p>
<h2 id="how-it-works">How It Works</h2>
<p>Under the hood, <code>ASSERT_EXIT()</code> spawns a new process and
executes the death test statement in that process. The details of of how
precisely that happens depend on the platform and the variable
<code>::testing::GTEST_FLAG(death_test_style)</code> (which is
initialized from the command-line flag
<code>--gtest_death_test_style</code>).</p>
<ul>
<li>On POSIX systems, <code>fork()</code> (or <code>clone()</code> on
Linux) is used to spawn the child, after which:
<ul>
<li>If the variable's value is <code>"fast"</code>, the death test
statement is immediately executed.</li>
<li>If the variable's value is <code>"threadsafe"</code>, the child
process re-executes the unit test binary just as it was originally
invoked, but with some extra flags to cause just the single death test
under consideration to be run.</li>
</ul></li>
<li>On Windows, the child is spawned using the
<code>CreateProcess()</code> API, and re-executes the binary to cause
just the single death test under consideration to be run - much like the
<code>threadsafe</code> mode on POSIX.</li>
</ul>
<p>Other values for the variable are illegal and will cause the death
test to fail. Currently, the flag's default value is
<code>"fast"</code>. However, we reserve the right to change it in the
future. Therefore, your tests should not depend on this.</p>
<p>In either case, the parent process waits for the child process to
complete, and checks that</p>
<ol type="1">
<li>the child's exit status satisfies the predicate, and</li>
<li>the child's stderr matches the regular expression.</li>
</ol>
<p>If the death test statement runs to completion without dying, the
child process will nonetheless terminate, and the assertion fails.</p>
<h2 id="death-tests-and-threads">Death Tests And Threads</h2>
<p>The reason for the two death test styles has to do with thread
safety. Due to well-known problems with forking in the presence of
threads, death tests should be run in a single-threaded context.
Sometimes, however, it isn't feasible to arrange that kind of
environment. For example, statically-initialized modules may start
threads before main is ever reached. Once threads have been created, it
may be difficult or impossible to clean them up.</p>
<p>Google Test has three features intended to raise awareness of
threading issues.</p>
<ol type="1">
<li>A warning is emitted if multiple threads are running when a death
test is encountered.</li>
<li>Test cases with a name ending in "DeathTest" are run before all
other tests.</li>
<li>It uses <code>clone()</code> instead of <code>fork()</code> to spawn
the child process on Linux (<code>clone()</code> is not available on
Cygwin and Mac), as <code>fork()</code> is more likely to cause the
child to hang when the parent process has multiple threads.</li>
</ol>
<p>It's perfectly fine to create threads inside a death test statement;
they are executed in a separate process and cannot affect the
parent.</p>
<h2 id="death-test-styles">Death Test Styles</h2>
<p>The "threadsafe" death test style was introduced in order to help
mitigate the risks of testing in a possibly multithreaded environment.
It trades increased test execution time (potentially dramatically so)
for improved thread safety. We suggest using the faster, default "fast"
style unless your test has specific problems with it.</p>
<p>You can choose a particular style of death tests by setting the flag
programmatically:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">::testing::FLAGS_gtest_death_test_style = &quot;threadsafe&quot;;</span><br></pre></td></tr></table></figure>
<p>You can do this in <code>main()</code> to set the style for all death
tests in the binary, or in individual tests. Recall that flags are saved
before running each test and restored afterwards, so you need not do
that yourself. For example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TEST(MyDeathTest, TestOne) &#123;</span><br><span class="line">  ::testing::FLAGS_gtest_death_test_style = &quot;threadsafe&quot;;</span><br><span class="line">  // This test is run in the &quot;threadsafe&quot; style:</span><br><span class="line">  ASSERT_DEATH(ThisShouldDie(), &quot;&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST(MyDeathTest, TestTwo) &#123;</span><br><span class="line">  // This test is run in the &quot;fast&quot; style:</span><br><span class="line">  ASSERT_DEATH(ThisShouldDie(), &quot;&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char** argv) &#123;</span><br><span class="line">  ::testing::InitGoogleTest(&amp;argc, argv);</span><br><span class="line">  ::testing::FLAGS_gtest_death_test_style = &quot;fast&quot;;</span><br><span class="line">  return RUN_ALL_TESTS();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="caveats">Caveats</h2>
<p>The <em>statement</em> argument of <code>ASSERT_EXIT()</code> can be
any valid C++ statement. If it leaves the current function via a
<code>return</code> statement or by throwing an exception, the death
test is considered to have failed. Some Google Test macros may return
from the current function (e.g. <code>ASSERT_TRUE()</code>), so be sure
to avoid them in <em>statement</em>.</p>
<p>Since <em>statement</em> runs in the child process, any in-memory
side effect (e.g. modifying a variable, releasing memory, etc) it causes
will <em>not</em> be observable in the parent process. In particular, if
you release memory in a death test, your program will fail the heap
check as the parent process will never see the memory reclaimed. To
solve this problem, you can</p>
<ol type="1">
<li>try not to free memory in a death test;</li>
<li>free the memory again in the parent process; or</li>
<li>do not use the heap checker in your program.</li>
</ol>
<p>Due to an implementation detail, you cannot place multiple death test
assertions on the same line; otherwise, compilation will fail with an
unobvious error message.</p>
<p>Despite the improved thread safety afforded by the "threadsafe" style
of death test, thread problems such as deadlock are still possible in
the presence of handlers registered with
<code>pthread_atfork(3)</code>.</p>
<h1 id="using-assertions-in-sub-routines">Using Assertions in
Sub-routines</h1>
<h2 id="adding-traces-to-assertions">Adding Traces to Assertions</h2>
<p>If a test sub-routine is called from several places, when an
assertion inside it fails, it can be hard to tell which invocation of
the sub-routine the failure is from. You can alleviate this problem
using extra logging or custom failure messages, but that usually
clutters up your tests. A better solution is to use the
<code>SCOPED_TRACE</code> macro:</p>
<table>
<thead>
<tr class="header">
<th
style="text-align: left;"><code>SCOPED_TRACE(</code><em>message</em><code>);</code></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>where <em>message</em> can be anything streamable to
<code>std::ostream</code>. This macro will cause the current file name,
line number, and the given message to be added in every failure message.
The effect will be undone when the control leaves the current lexical
scope.</p>
<p>For example,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">10: void Sub1(int n) &#123;</span><br><span class="line">11:   EXPECT_EQ(1, Bar(n));</span><br><span class="line">12:   EXPECT_EQ(2, Bar(n + 1));</span><br><span class="line">13: &#125;</span><br><span class="line">14:</span><br><span class="line">15: TEST(FooTest, Bar) &#123;</span><br><span class="line">16:   &#123;</span><br><span class="line">17:     SCOPED_TRACE(&quot;A&quot;);  // This trace point will be included in</span><br><span class="line">18:                         // every failure in this scope.</span><br><span class="line">19:     Sub1(1);</span><br><span class="line">20:   &#125;</span><br><span class="line">21:   // Now it won&#x27;t.</span><br><span class="line">22:   Sub1(9);</span><br><span class="line">23: &#125;</span><br></pre></td></tr></table></figure>
<p>could result in messages like these:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">path/to/foo_test.cc:11: Failure</span><br><span class="line">Value of: Bar(n)</span><br><span class="line">Expected: 1</span><br><span class="line">  Actual: 2</span><br><span class="line">   Trace:</span><br><span class="line">path/to/foo_test.cc:17: A</span><br><span class="line"></span><br><span class="line">path/to/foo_test.cc:12: Failure</span><br><span class="line">Value of: Bar(n + 1)</span><br><span class="line">Expected: 2</span><br><span class="line">  Actual: 3</span><br></pre></td></tr></table></figure>
<p>Without the trace, it would've been difficult to know which
invocation of <code>Sub1()</code> the two failures come from
respectively. (You could add an extra message to each assertion in
<code>Sub1()</code> to indicate the value of <code>n</code>, but that's
tedious.)</p>
<p>Some tips on using <code>SCOPED_TRACE</code>:</p>
<ol type="1">
<li>With a suitable message, it's often enough to use
<code>SCOPED_TRACE</code> at the beginning of a sub-routine, instead of
at each call site.</li>
<li>When calling sub-routines inside a loop, make the loop iterator part
of the message in <code>SCOPED_TRACE</code> such that you can know which
iteration the failure is from.</li>
<li>Sometimes the line number of the trace point is enough for
identifying the particular invocation of a sub-routine. In this case,
you don't have to choose a unique message for <code>SCOPED_TRACE</code>.
You can simply use <code>""</code>.</li>
<li>You can use <code>SCOPED_TRACE</code> in an inner scope when there
is one in the outer scope. In this case, all active trace points will be
included in the failure messages, in reverse order they are
encountered.</li>
<li>The trace dump is clickable in Emacs' compilation buffer - hit
return on a line number and you'll be taken to that line in the source
file!</li>
</ol>
<p><em>Availability:</em> Linux, Windows, Mac.</p>
<h2 id="propagating-fatal-failures">Propagating Fatal Failures</h2>
<p>A common pitfall when using <code>ASSERT_*</code> and
<code>FAIL*</code> is not understanding that when they fail they only
abort the <em>current function</em>, not the entire test. For example,
the following test will segfault: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">void Subroutine() &#123;</span><br><span class="line">  // Generates a fatal failure and aborts the current function.</span><br><span class="line">  ASSERT_EQ(1, 2);</span><br><span class="line">  // The following won&#x27;t be executed.</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST(FooTest, Bar) &#123;</span><br><span class="line">  Subroutine();</span><br><span class="line">  // The intended behavior is for the fatal failure</span><br><span class="line">  // in Subroutine() to abort the entire test.</span><br><span class="line">  // The actual behavior: the function goes on after Subroutine() returns.</span><br><span class="line">  int* p = NULL;</span><br><span class="line">  *p = 3; // Segfault!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Since we don't use exceptions, it is technically impossible to
implement the intended behavior here. To alleviate this, Google Test
provides two solutions. You could use either the
<code>(ASSERT|EXPECT)_NO_FATAL_FAILURE</code> assertions or the
<code>HasFatalFailure()</code> function. They are described in the
following two subsections.</p>
<h3 id="asserting-on-subroutines">Asserting on Subroutines</h3>
<p>As shown above, if your test calls a subroutine that has an
<code>ASSERT_*</code> failure in it, the test will continue after the
subroutine returns. This may not be what you want.</p>
<p>Often people want fatal failures to propagate like exceptions. For
that Google Test offers the following macros:</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 40%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><strong>Fatal assertion</strong></th>
<th style="text-align: left;"><strong>Nonfatal assertion</strong></th>
<th style="text-align: left;"><strong>Verifies</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td
style="text-align: left;"><code>ASSERT_NO_FATAL_FAILURE(</code><em>statement</em><code>);</code></td>
<td
style="text-align: left;"><code>EXPECT_NO_FATAL_FAILURE(</code><em>statement</em><code>);</code></td>
<td style="text-align: left;"><em>statement</em> doesn't generate any
new fatal failures in the current thread.</td>
</tr>
</tbody>
</table>
<p>Only failures in the thread that executes the assertion are checked
to determine the result of this type of assertions. If
<em>statement</em> creates new threads, failures in these threads are
ignored.</p>
<p>Examples:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ASSERT_NO_FATAL_FAILURE(Foo());</span><br><span class="line"></span><br><span class="line">int i;</span><br><span class="line">EXPECT_NO_FATAL_FAILURE(&#123;</span><br><span class="line">  i = Bar();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><em>Availability:</em> Linux, Windows, Mac. Assertions from multiple
threads are currently not supported.</p>
<h3 id="checking-for-failures-in-the-current-test">Checking for Failures
in the Current Test</h3>
<p><code>HasFatalFailure()</code> in the <code>::testing::Test</code>
class returns <code>true</code> if an assertion in the current test has
suffered a fatal failure. This allows functions to catch fatal failures
in a sub-routine and return early.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Test &#123;</span><br><span class="line"> public:</span><br><span class="line">  ...</span><br><span class="line">  static bool HasFatalFailure();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The typical usage, which basically simulates the behavior of a thrown
exception, is:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TEST(FooTest, Bar) &#123;</span><br><span class="line">  Subroutine();</span><br><span class="line">  // Aborts if Subroutine() had a fatal failure.</span><br><span class="line">  if (HasFatalFailure())</span><br><span class="line">    return;</span><br><span class="line">  // The following won&#x27;t be executed.</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If <code>HasFatalFailure()</code> is used outside of
<code>TEST()</code> , <code>TEST_F()</code> , or a test fixture, you
must add the <code>::testing::Test::</code> prefix, as in:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if (::testing::Test::HasFatalFailure())</span><br><span class="line">  return;</span><br></pre></td></tr></table></figure>
<p>Similarly, <code>HasNonfatalFailure()</code> returns
<code>true</code> if the current test has at least one non-fatal
failure, and <code>HasFailure()</code> returns <code>true</code> if the
current test has at least one failure of either kind.</p>
<p><em>Availability:</em> Linux, Windows, Mac.
<code>HasNonfatalFailure()</code> and <code>HasFailure()</code> are
available since version 1.4.0.</p>
<h1 id="logging-additional-information">Logging Additional
Information</h1>
<p>In your test code, you can call
<code>RecordProperty("key", value)</code> to log additional information,
where <code>value</code> can be either a string or an <code>int</code>.
The <em>last</em> value recorded for a key will be emitted to the XML
output if you specify one. For example, the test</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TEST_F(WidgetUsageTest, MinAndMaxWidgets) &#123;</span><br><span class="line">  RecordProperty(&quot;MaximumWidgets&quot;, ComputeMaxUsage());</span><br><span class="line">  RecordProperty(&quot;MinimumWidgets&quot;, ComputeMinUsage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>will output XML like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  &lt;testcase name=&quot;MinAndMaxWidgets&quot; status=&quot;run&quot; time=&quot;6&quot; classname=&quot;WidgetUsageTest&quot;</span><br><span class="line">            MaximumWidgets=&quot;12&quot;</span><br><span class="line">            MinimumWidgets=&quot;9&quot; /&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><em>Note</em>: * <code>RecordProperty()</code> is a static member of
the <code>Test</code> class. Therefore it needs to be prefixed with
<code>::testing::Test::</code> if used outside of the <code>TEST</code>
body and the test fixture class. * <code>key</code> must be a valid XML
attribute name, and cannot conflict with the ones already used by Google
Test (<code>name</code>, <code>status</code>, <code>time</code>,
<code>classname</code>, <code>type_param</code>, and
<code>value_param</code>). * Calling <code>RecordProperty()</code>
outside of the lifespan of a test is allowed. If it's called outside of
a test but between a test case's <code>SetUpTestCase()</code> and
<code>TearDownTestCase()</code> methods, it will be attributed to the
XML element for the test case. If it's called outside of all test cases
(e.g. in a test environment), it will be attributed to the top-level XML
element.</p>
<p><em>Availability</em>: Linux, Windows, Mac.</p>
<h1 id="sharing-resources-between-tests-in-the-same-test-case">Sharing
Resources Between Tests in the Same Test Case</h1>
<p>Google Test creates a new test fixture object for each test in order
to make tests independent and easier to debug. However, sometimes tests
use resources that are expensive to set up, making the one-copy-per-test
model prohibitively expensive.</p>
<p>If the tests don't change the resource, there's no harm in them
sharing a single resource copy. So, in addition to per-test
set-up/tear-down, Google Test also supports per-test-case
set-up/tear-down. To use it:</p>
<ol type="1">
<li>In your test fixture class (say <code>FooTest</code> ), define as
<code>static</code> some member variables to hold the shared
resources.</li>
<li>In the same test fixture class, define a
<code>static void SetUpTestCase()</code> function (remember not to spell
it as <strong><code>SetupTestCase</code></strong> with a small
<code>u</code>!) to set up the shared resources and a
<code>static void TearDownTestCase()</code> function to tear them
down.</li>
</ol>
<p>That's it! Google Test automatically calls
<code>SetUpTestCase()</code> before running the <em>first test</em> in
the <code>FooTest</code> test case (i.e. before creating the first
<code>FooTest</code> object), and calls <code>TearDownTestCase()</code>
after running the <em>last test</em> in it (i.e. after deleting the last
<code>FooTest</code> object). In between, the tests can use the shared
resources.</p>
<p>Remember that the test order is undefined, so your code can't depend
on a test preceding or following another. Also, the tests must either
not modify the state of any shared resource, or, if they do modify the
state, they must restore the state to its original value before passing
control to the next test.</p>
<p>Here's an example of per-test-case set-up and tear-down:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">class FooTest : public ::testing::Test &#123;</span><br><span class="line"> protected:</span><br><span class="line">  // Per-test-case set-up.</span><br><span class="line">  // Called before the first test in this test case.</span><br><span class="line">  // Can be omitted if not needed.</span><br><span class="line">  static void SetUpTestCase() &#123;</span><br><span class="line">    shared_resource_ = new ...;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Per-test-case tear-down.</span><br><span class="line">  // Called after the last test in this test case.</span><br><span class="line">  // Can be omitted if not needed.</span><br><span class="line">  static void TearDownTestCase() &#123;</span><br><span class="line">    delete shared_resource_;</span><br><span class="line">    shared_resource_ = NULL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // You can define per-test set-up and tear-down logic as usual.</span><br><span class="line">  virtual void SetUp() &#123; ... &#125;</span><br><span class="line">  virtual void TearDown() &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">  // Some expensive resource shared by all tests.</span><br><span class="line">  static T* shared_resource_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">T* FooTest::shared_resource_ = NULL;</span><br><span class="line"></span><br><span class="line">TEST_F(FooTest, Test1) &#123;</span><br><span class="line">  ... you can refer to shared_resource here ...</span><br><span class="line">&#125;</span><br><span class="line">TEST_F(FooTest, Test2) &#123;</span><br><span class="line">  ... you can refer to shared_resource here ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>Availability:</em> Linux, Windows, Mac.</p>
<h1 id="global-set-up-and-tear-down">Global Set-Up and Tear-Down</h1>
<p>Just as you can do set-up and tear-down at the test level and the
test case level, you can also do it at the test program level. Here's
how.</p>
<p>First, you subclass the <code>::testing::Environment</code> class to
define a test environment, which knows how to set-up and tear-down:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class Environment &#123;</span><br><span class="line"> public:</span><br><span class="line">  virtual ~Environment() &#123;&#125;</span><br><span class="line">  // Override this to define how to set up the environment.</span><br><span class="line">  virtual void SetUp() &#123;&#125;</span><br><span class="line">  // Override this to define how to tear down the environment.</span><br><span class="line">  virtual void TearDown() &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Then, you register an instance of your environment class with Google
Test by calling the <code>::testing::AddGlobalTestEnvironment()</code>
function:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Environment* AddGlobalTestEnvironment(Environment* env);</span><br></pre></td></tr></table></figure>
<p>Now, when <code>RUN_ALL_TESTS()</code> is called, it first calls the
<code>SetUp()</code> method of the environment object, then runs the
tests if there was no fatal failures, and finally calls
<code>TearDown()</code> of the environment object.</p>
<p>It's OK to register multiple environment objects. In this case, their
<code>SetUp()</code> will be called in the order they are registered,
and their <code>TearDown()</code> will be called in the reverse
order.</p>
<p>Note that Google Test takes ownership of the registered environment
objects. Therefore <strong>do not delete them</strong> by yourself.</p>
<p>You should call <code>AddGlobalTestEnvironment()</code> before
<code>RUN_ALL_TESTS()</code> is called, probably in <code>main()</code>.
If you use <code>gtest_main</code>, you need to call this before
<code>main()</code> starts for it to take effect. One way to do this is
to define a global variable like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">::testing::Environment* const foo_env = ::testing::AddGlobalTestEnvironment(new FooEnvironment);</span><br></pre></td></tr></table></figure>
<p>However, we strongly recommend you to write your own
<code>main()</code> and call <code>AddGlobalTestEnvironment()</code>
there, as relying on initialization of global variables makes the code
harder to read and may cause problems when you register multiple
environments from different translation units and the environments have
dependencies among them (remember that the compiler doesn't guarantee
the order in which global variables from different translation units are
initialized).</p>
<p><em>Availability:</em> Linux, Windows, Mac.</p>
<h1 id="value-parameterized-tests">Value Parameterized Tests</h1>
<p><em>Value-parameterized tests</em> allow you to test your code with
different parameters without writing multiple copies of the same
test.</p>
<p>Suppose you write a test for your code and then realize that your
code is affected by a presence of a Boolean command line flag.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEST(MyCodeTest, TestFoo) &#123;</span><br><span class="line">  // A code to test foo().</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Usually people factor their test code into a function with a Boolean
parameter in such situations. The function sets the flag, then executes
the testing code.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">void TestFooHelper(bool flag_value) &#123;</span><br><span class="line">  flag = flag_value;</span><br><span class="line">  // A code to test foo().</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST(MyCodeTest, TestFoo) &#123;</span><br><span class="line">  TestFooHelper(false);</span><br><span class="line">  TestFooHelper(true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>But this setup has serious drawbacks. First, when a test assertion
fails in your tests, it becomes unclear what value of the parameter
caused it to fail. You can stream a clarifying message into your
<code>EXPECT</code>/<code>ASSERT</code> statements, but it you'll have
to do it with all of them. Second, you have to add one such helper
function per test. What if you have ten tests? Twenty? A hundred?</p>
<p>Value-parameterized tests will let you write your test only once and
then easily instantiate and run it with an arbitrary number of parameter
values.</p>
<p>Here are some other situations when value-parameterized tests come
handy:</p>
<ul>
<li>You want to test different implementations of an OO interface.</li>
<li>You want to test your code over various inputs (a.k.a. data-driven
testing). This feature is easy to abuse, so please exercise your good
sense when doing it!</li>
</ul>
<h2 id="how-to-write-value-parameterized-tests">How to Write
Value-Parameterized Tests</h2>
<p>To write value-parameterized tests, first you should define a fixture
class. It must be derived from both <code>::testing::Test</code> and
<code>::testing::WithParamInterface&lt;T&gt;</code> (the latter is a
pure interface), where <code>T</code> is the type of your parameter
values. For convenience, you can just derive the fixture class from
<code>::testing::TestWithParam&lt;T&gt;</code>, which itself is derived
from both <code>::testing::Test</code> and
<code>::testing::WithParamInterface&lt;T&gt;</code>. <code>T</code> can
be any copyable type. If it's a raw pointer, you are responsible for
managing the lifespan of the pointed values.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class FooTest : public ::testing::TestWithParam&lt;const char*&gt; &#123;</span><br><span class="line">  // You can implement all the usual fixture class members here.</span><br><span class="line">  // To access the test parameter, call GetParam() from class</span><br><span class="line">  // TestWithParam&lt;T&gt;.</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// Or, when you want to add parameters to a pre-existing fixture class:</span><br><span class="line">class BaseTest : public ::testing::Test &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line">class BarTest : public BaseTest,</span><br><span class="line">                public ::testing::WithParamInterface&lt;const char*&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Then, use the <code>TEST_P</code> macro to define as many test
patterns using this fixture as you want. The <code>_P</code> suffix is
for "parameterized" or "pattern", whichever you prefer to think.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">TEST_P(FooTest, DoesBlah) &#123;</span><br><span class="line">  // Inside a test, access the test parameter with the GetParam() method</span><br><span class="line">  // of the TestWithParam&lt;T&gt; class:</span><br><span class="line">  EXPECT_TRUE(foo.Blah(GetParam()));</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST_P(FooTest, HasBlahBlah) &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Finally, you can use <code>INSTANTIATE_TEST_CASE_P</code> to
instantiate the test case with any set of parameters you want. Google
Test defines a number of functions for generating test parameters. They
return what we call (surprise!) <em>parameter generators</em>. Here is a
summary of them, which are all in the <code>testing</code>
namespace:</p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 79%" />
</colgroup>
<thead>
<tr class="header">
<th
style="text-align: left;"><code>Range(begin, end[, step])</code></th>
<th style="text-align: left;">Yields values
<code>&#123;begin, begin+step, begin+step+step, ...&#125;</code>. The values do
not include <code>end</code>. <code>step</code> defaults to 1.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>Values(v1, v2, ..., vN)</code></td>
<td style="text-align: left;">Yields values
<code>&#123;v1, v2, ..., vN&#125;</code>.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ValuesIn(container)</code> and
<code>ValuesIn(begin, end)</code></td>
<td style="text-align: left;">Yields values from a C-style array, an
STL-style container, or an iterator range <code>[begin, end)</code>.
<code>container</code>, <code>begin</code>, and <code>end</code> can be
expressions whose values are determined at run time.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>Bool()</code></td>
<td style="text-align: left;">Yields sequence
<code>&#123;false, true&#125;</code>.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>Combine(g1, g2, ..., gN)</code></td>
<td style="text-align: left;">Yields all combinations (the Cartesian
product for the math savvy) of the values generated by the
<code>N</code> generators. This is only available if your system
provides the <code>&lt;tr1/tuple&gt;</code> header. If you are sure your
system does, and Google Test disagrees, you can override it by defining
<code>GTEST_HAS_TR1_TUPLE=1</code>. See comments in <a
href="../include/gtest/internal/gtest-port.h">include/gtest/internal/gtest-port.h</a>
for more information.</td>
</tr>
</tbody>
</table>
<p>For more details, see the comments at the definitions of these
functions in the <a href="../include/gtest/gtest-param-test.h">source
code</a>.</p>
<p>The following statement will instantiate tests from the
<code>FooTest</code> test case each with parameter values
<code>"meeny"</code>, <code>"miny"</code>, and <code>"moe"</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INSTANTIATE_TEST_CASE_P(InstantiationName,</span><br><span class="line">                        FooTest,</span><br><span class="line">                        ::testing::Values(&quot;meeny&quot;, &quot;miny&quot;, &quot;moe&quot;));</span><br></pre></td></tr></table></figure>
<p>To distinguish different instances of the pattern (yes, you can
instantiate it more than once), the first argument to
<code>INSTANTIATE_TEST_CASE_P</code> is a prefix that will be added to
the actual test case name. Remember to pick unique prefixes for
different instantiations. The tests from the instantiation above will
have these names:</p>
<ul>
<li><code>InstantiationName/FooTest.DoesBlah/0</code> for
<code>"meeny"</code></li>
<li><code>InstantiationName/FooTest.DoesBlah/1</code> for
<code>"miny"</code></li>
<li><code>InstantiationName/FooTest.DoesBlah/2</code> for
<code>"moe"</code></li>
<li><code>InstantiationName/FooTest.HasBlahBlah/0</code> for
<code>"meeny"</code></li>
<li><code>InstantiationName/FooTest.HasBlahBlah/1</code> for
<code>"miny"</code></li>
<li><code>InstantiationName/FooTest.HasBlahBlah/2</code> for
<code>"moe"</code></li>
</ul>
<p>You can use these names in <a
href="#running-a-subset-of-the-tests">--gtest_filter</a>.</p>
<p>This statement will instantiate all tests from <code>FooTest</code>
again, each with parameter values <code>"cat"</code> and
<code>"dog"</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const char* pets[] = &#123;&quot;cat&quot;, &quot;dog&quot;&#125;;</span><br><span class="line">INSTANTIATE_TEST_CASE_P(AnotherInstantiationName, FooTest,</span><br><span class="line">                        ::testing::ValuesIn(pets));</span><br></pre></td></tr></table></figure>
<p>The tests from the instantiation above will have these names:</p>
<ul>
<li><code>AnotherInstantiationName/FooTest.DoesBlah/0</code> for
<code>"cat"</code></li>
<li><code>AnotherInstantiationName/FooTest.DoesBlah/1</code> for
<code>"dog"</code></li>
<li><code>AnotherInstantiationName/FooTest.HasBlahBlah/0</code> for
<code>"cat"</code></li>
<li><code>AnotherInstantiationName/FooTest.HasBlahBlah/1</code> for
<code>"dog"</code></li>
</ul>
<p>Please note that <code>INSTANTIATE_TEST_CASE_P</code> will
instantiate <em>all</em> tests in the given test case, whether their
definitions come before or <em>after</em> the
<code>INSTANTIATE_TEST_CASE_P</code> statement.</p>
<p>You can see <a href="../samples/sample7_unittest.cc">these</a> <a
href="../samples/sample8_unittest.cc">files</a> for more examples.</p>
<p><em>Availability</em>: Linux, Windows (requires MSVC 8.0 or above),
Mac; since version 1.2.0.</p>
<h2 id="creating-value-parameterized-abstract-tests">Creating
Value-Parameterized Abstract Tests</h2>
<p>In the above, we define and instantiate <code>FooTest</code> in the
same source file. Sometimes you may want to define value-parameterized
tests in a library and let other people instantiate them later. This
pattern is known as <i>abstract tests</i>. As an example of its
application, when you are designing an interface you can write a
standard suite of abstract tests (perhaps using a factory function as
the test parameter) that all implementations of the interface are
expected to pass. When someone implements the interface, he can
instantiate your suite to get all the interface-conformance tests for
free.</p>
<p>To define abstract tests, you should organize your code like
this:</p>
<ol type="1">
<li>Put the definition of the parameterized test fixture class (e.g.
<code>FooTest</code>) in a header file, say
<code>foo_param_test.h</code>. Think of this as <em>declaring</em> your
abstract tests.</li>
<li>Put the <code>TEST_P</code> definitions in
<code>foo_param_test.cc</code>, which includes
<code>foo_param_test.h</code>. Think of this as <em>implementing</em>
your abstract tests.</li>
</ol>
<p>Once they are defined, you can instantiate them by including
<code>foo_param_test.h</code>, invoking
<code>INSTANTIATE_TEST_CASE_P()</code>, and linking with
<code>foo_param_test.cc</code>. You can instantiate the same abstract
test case multiple times, possibly in different source files.</p>
<h1 id="typed-tests">Typed Tests</h1>
<p>Suppose you have multiple implementations of the same interface and
want to make sure that all of them satisfy some common requirements. Or,
you may have defined several types that are supposed to conform to the
same "concept" and you want to verify it. In both cases, you want the
same test logic repeated for different types.</p>
<p>While you can write one <code>TEST</code> or <code>TEST_F</code> for
each type you want to test (and you may even factor the test logic into
a function template that you invoke from the <code>TEST</code>), it's
tedious and doesn't scale: if you want <em>m</em> tests over <em>n</em>
types, you'll end up writing <em>m*n</em> <code>TEST</code>s.</p>
<p><em>Typed tests</em> allow you to repeat the same test logic over a
list of types. You only need to write the test logic once, although you
must know the type list when writing typed tests. Here's how you do
it:</p>
<p>First, define a fixture class template. It should be parameterized by
a type. Remember to derive it from <code>::testing::Test</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">template &lt;typename T&gt;</span><br><span class="line">class FooTest : public ::testing::Test &#123;</span><br><span class="line"> public:</span><br><span class="line">  ...</span><br><span class="line">  typedef std::list&lt;T&gt; List;</span><br><span class="line">  static T shared_;</span><br><span class="line">  T value_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Next, associate a list of types with the test case, which will be
repeated for each type in the list:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">typedef ::testing::Types&lt;char, int, unsigned int&gt; MyTypes;</span><br><span class="line">TYPED_TEST_CASE(FooTest, MyTypes);</span><br></pre></td></tr></table></figure>
<p>The <code>typedef</code> is necessary for the
<code>TYPED_TEST_CASE</code> macro to parse correctly. Otherwise the
compiler will think that each comma in the type list introduces a new
macro argument.</p>
<p>Then, use <code>TYPED_TEST()</code> instead of <code>TEST_F()</code>
to define a typed test for this test case. You can repeat this as many
times as you want:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">TYPED_TEST(FooTest, DoesBlah) &#123;</span><br><span class="line">  // Inside a test, refer to the special name TypeParam to get the type</span><br><span class="line">  // parameter.  Since we are inside a derived class template, C++ requires</span><br><span class="line">  // us to visit the members of FooTest via &#x27;this&#x27;.</span><br><span class="line">  TypeParam n = this-&gt;value_;</span><br><span class="line"></span><br><span class="line">  // To visit static members of the fixture, add the &#x27;TestFixture::&#x27;</span><br><span class="line">  // prefix.</span><br><span class="line">  n += TestFixture::shared_;</span><br><span class="line"></span><br><span class="line">  // To refer to typedefs in the fixture, add the &#x27;typename TestFixture::&#x27;</span><br><span class="line">  // prefix.  The &#x27;typename&#x27; is required to satisfy the compiler.</span><br><span class="line">  typename TestFixture::List values;</span><br><span class="line">  values.push_back(n);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TYPED_TEST(FooTest, HasPropertyA) &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>You can see <code>samples/sample6_unittest.cc</code> for a complete
example.</p>
<p><em>Availability:</em> Linux, Windows (requires MSVC 8.0 or above),
Mac; since version 1.1.0.</p>
<h1 id="type-parameterized-tests">Type-Parameterized Tests</h1>
<p><em>Type-parameterized tests</em> are like typed tests, except that
they don't require you to know the list of types ahead of time. Instead,
you can define the test logic first and instantiate it with different
type lists later. You can even instantiate it more than once in the same
program.</p>
<p>If you are designing an interface or concept, you can define a suite
of type-parameterized tests to verify properties that any valid
implementation of the interface/concept should have. Then, the author of
each implementation can just instantiate the test suite with his type to
verify that it conforms to the requirements, without having to write
similar tests repeatedly. Here's an example:</p>
<p>First, define a fixture class template, as we did with typed
tests:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">template &lt;typename T&gt;</span><br><span class="line">class FooTest : public ::testing::Test &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Next, declare that you will define a type-parameterized test
case:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TYPED_TEST_CASE_P(FooTest);</span><br></pre></td></tr></table></figure>
<p>The <code>_P</code> suffix is for "parameterized" or "pattern",
whichever you prefer to think.</p>
<p>Then, use <code>TYPED_TEST_P()</code> to define a type-parameterized
test. You can repeat this as many times as you want:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TYPED_TEST_P(FooTest, DoesBlah) &#123;</span><br><span class="line">  // Inside a test, refer to TypeParam to get the type parameter.</span><br><span class="line">  TypeParam n = 0;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TYPED_TEST_P(FooTest, HasPropertyA) &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>Now the tricky part: you need to register all test patterns using the
<code>REGISTER_TYPED_TEST_CASE_P</code> macro before you can instantiate
them. The first argument of the macro is the test case name; the rest
are the names of the tests in this test case:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REGISTER_TYPED_TEST_CASE_P(FooTest,</span><br><span class="line">                           DoesBlah, HasPropertyA);</span><br></pre></td></tr></table></figure>
<p>Finally, you are free to instantiate the pattern with the types you
want. If you put the above code in a header file, you can
<code>#include</code> it in multiple C++ source files and instantiate it
multiple times.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">typedef ::testing::Types&lt;char, int, unsigned int&gt; MyTypes;</span><br><span class="line">INSTANTIATE_TYPED_TEST_CASE_P(My, FooTest, MyTypes);</span><br></pre></td></tr></table></figure>
<p>To distinguish different instances of the pattern, the first argument
to the <code>INSTANTIATE_TYPED_TEST_CASE_P</code> macro is a prefix that
will be added to the actual test case name. Remember to pick unique
prefixes for different instances.</p>
<p>In the special case where the type list contains only one type, you
can write that type directly without
<code>::testing::Types&lt;...&gt;</code>, like this:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSTANTIATE_TYPED_TEST_CASE_P(My, FooTest, int);</span><br></pre></td></tr></table></figure>
<p>You can see <code>samples/sample6_unittest.cc</code> for a complete
example.</p>
<p><em>Availability:</em> Linux, Windows (requires MSVC 8.0 or above),
Mac; since version 1.1.0.</p>
<h1 id="testing-private-code">Testing Private Code</h1>
<p>If you change your software's internal implementation, your tests
should not break as long as the change is not observable by users.
Therefore, per the <em>black-box testing principle</em>, most of the
time you should test your code through its public interfaces.</p>
<p>If you still find yourself needing to test internal implementation
code, consider if there's a better design that wouldn't require you to
do so. If you absolutely have to test non-public interface code though,
you can. There are two cases to consider:</p>
<ul>
<li>Static functions (<em>not</em> the same as static member functions!)
or unnamed namespaces, and</li>
<li>Private or protected class members</li>
</ul>
<h2 id="static-functions">Static Functions</h2>
<p>Both static functions and definitions/declarations in an unnamed
namespace are only visible within the same translation unit. To test
them, you can <code>#include</code> the entire <code>.cc</code> file
being tested in your <code>*_test.cc</code> file.
(<code>#include</code>ing <code>.cc</code> files is not a good way to
reuse code - you should not do this in production code!)</p>
<p>However, a better approach is to move the private code into the
<code>foo::internal</code> namespace, where <code>foo</code> is the
namespace your project normally uses, and put the private declarations
in a <code>*-internal.h</code> file. Your production <code>.cc</code>
files and your tests are allowed to include this internal header, but
your clients are not. This way, you can fully test your internal
implementation without leaking it to your clients.</p>
<h2 id="private-class-members">Private Class Members</h2>
<p>Private class members are only accessible from within the class or by
friends. To access a class' private members, you can declare your test
fixture as a friend to the class and define accessors in your fixture.
Tests using the fixture can then access the private members of your
production class via the accessors in the fixture. Note that even though
your fixture is a friend to your production class, your tests are not
automatically friends to it, as they are technically defined in
sub-classes of the fixture.</p>
<p>Another way to test private members is to refactor them into an
implementation class, which is then declared in a
<code>*-internal.h</code> file. Your clients aren't allowed to include
this header but your tests can. Such is called the Pimpl (Private
Implementation) idiom.</p>
<p>Or, you can declare an individual test as a friend of your class by
adding this line in the class body:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FRIEND_TEST(TestCaseName, TestName);</span><br></pre></td></tr></table></figure>
<p>For example, <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// foo.h</span><br><span class="line">#include &quot;gtest/gtest_prod.h&quot;</span><br><span class="line"></span><br><span class="line">// Defines FRIEND_TEST.</span><br><span class="line">class Foo &#123;</span><br><span class="line">  ...</span><br><span class="line"> private:</span><br><span class="line">  FRIEND_TEST(FooTest, BarReturnsZeroOnNull);</span><br><span class="line">  int Bar(void* x);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// foo_test.cc</span><br><span class="line">...</span><br><span class="line">TEST(FooTest, BarReturnsZeroOnNull) &#123;</span><br><span class="line">  Foo foo;</span><br><span class="line">  EXPECT_EQ(0, foo.Bar(NULL));</span><br><span class="line">  // Uses Foo&#x27;s private member Bar().</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Pay special attention when your class is defined in a namespace, as
you should define your test fixtures and tests in the same namespace if
you want them to be friends of your class. For example, if the code to
be tested looks like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">namespace my_namespace &#123;</span><br><span class="line"></span><br><span class="line">class Foo &#123;</span><br><span class="line">  friend class FooTest;</span><br><span class="line">  FRIEND_TEST(FooTest, Bar);</span><br><span class="line">  FRIEND_TEST(FooTest, Baz);</span><br><span class="line">  ...</span><br><span class="line">  definition of the class Foo</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  // namespace my_namespace</span><br></pre></td></tr></table></figure>
<p>Your test code should be something like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">namespace my_namespace &#123;</span><br><span class="line">class FooTest : public ::testing::Test &#123;</span><br><span class="line"> protected:</span><br><span class="line">  ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">TEST_F(FooTest, Bar) &#123; ... &#125;</span><br><span class="line">TEST_F(FooTest, Baz) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">&#125;  // namespace my_namespace</span><br></pre></td></tr></table></figure>
<h1 id="catching-failures">Catching Failures</h1>
<p>If you are building a testing utility on top of Google Test, you'll
want to test your utility. What framework would you use to test it?
Google Test, of course.</p>
<p>The challenge is to verify that your testing utility reports failures
correctly. In frameworks that report a failure by throwing an exception,
you could catch the exception and assert on it. But Google Test doesn't
use exceptions, so how do we test that a piece of code generates an
expected failure?</p>
<p><code>"gtest/gtest-spi.h"</code> contains some constructs to do this.
After <code>#include</code>ing this header, you can use</p>
<table>
<thead>
<tr class="header">
<th
style="text-align: left;"><code>EXPECT_FATAL_FAILURE(</code><em>statement,
substring</em><code>);</code></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>to assert that <em>statement</em> generates a fatal (e.g.
<code>ASSERT_*</code>) failure whose message contains the given
<em>substring</em>, or use</p>
<table>
<thead>
<tr class="header">
<th
style="text-align: left;"><code>EXPECT_NONFATAL_FAILURE(</code><em>statement,
substring</em><code>);</code></th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<p>if you are expecting a non-fatal (e.g. <code>EXPECT_*</code>)
failure.</p>
<p>For technical reasons, there are some caveats:</p>
<ol type="1">
<li>You cannot stream a failure message to either macro.</li>
<li><em>statement</em> in <code>EXPECT_FATAL_FAILURE()</code> cannot
reference local non-static variables or non-static members of
<code>this</code> object.</li>
<li><em>statement</em> in <code>EXPECT_FATAL_FAILURE()</code> cannot
return a value.</li>
</ol>
<p><em>Note:</em> Google Test is designed with threads in mind. Once the
synchronization primitives in <code>"gtest/internal/gtest-port.h"</code>
have been implemented, Google Test will become thread-safe, meaning that
you can then use assertions in multiple threads concurrently. Before
that, however, Google Test only supports single-threaded usage. Once
thread-safe, <code>EXPECT_FATAL_FAILURE()</code> and
<code>EXPECT_NONFATAL_FAILURE()</code> will capture failures in the
current thread only. If <em>statement</em> creates new threads, failures
in these threads will be ignored. If you want to capture failures from
all threads instead, you should use the following macros:</p>
<table>
<thead>
<tr class="header">
<th
style="text-align: left;"><code>EXPECT_FATAL_FAILURE_ON_ALL_THREADS(</code><em>statement,
substring</em><code>);</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td
style="text-align: left;"><code>EXPECT_NONFATAL_FAILURE_ON_ALL_THREADS(</code><em>statement,
substring</em><code>);</code></td>
</tr>
</tbody>
</table>
<h1 id="getting-the-current-tests-name">Getting the Current Test's
Name</h1>
<p>Sometimes a function may need to know the name of the currently
running test. For example, you may be using the <code>SetUp()</code>
method of your test fixture to set the golden file name based on which
test is running. The <code>::testing::TestInfo</code> class has this
information:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">namespace testing &#123;</span><br><span class="line"></span><br><span class="line">class TestInfo &#123;</span><br><span class="line"> public:</span><br><span class="line">  // Returns the test case name and the test name, respectively.</span><br><span class="line">  //</span><br><span class="line">  // Do NOT delete or free the return value - it&#x27;s managed by the</span><br><span class="line">  // TestInfo class.</span><br><span class="line">  const char* test_case_name() const;</span><br><span class="line">  const char* name() const;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  // namespace testing</span><br></pre></td></tr></table></figure>
<blockquote>
<p>To obtain a <code>TestInfo</code> object for the currently running
test, call <code>current_test_info()</code> on the <code>UnitTest</code>
singleton object:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// Gets information about the currently running test.</span><br><span class="line">// Do NOT delete the returned object - it&#x27;s managed by the UnitTest class.</span><br><span class="line">const ::testing::TestInfo* const test_info =</span><br><span class="line">  ::testing::UnitTest::GetInstance()-&gt;current_test_info();</span><br><span class="line">printf(&quot;We are in test %s of test case %s.\n&quot;,</span><br><span class="line">       test_info-&gt;name(), test_info-&gt;test_case_name());</span><br></pre></td></tr></table></figure>
<p><code>current_test_info()</code> returns a null pointer if no test is
running. In particular, you cannot find the test case name in
<code>TestCaseSetUp()</code>, <code>TestCaseTearDown()</code> (where you
know the test case name implicitly), or functions called from them.</p>
<p><em>Availability:</em> Linux, Windows, Mac.</p>
<h1 id="extending-google-test-by-handling-test-events">Extending Google
Test by Handling Test Events</h1>
<p>Google Test provides an <b>event listener API</b> to let you receive
notifications about the progress of a test program and test failures.
The events you can listen to include the start and end of the test
program, a test case, or a test method, among others. You may use this
API to augment or replace the standard console output, replace the XML
output, or provide a completely different form of output, such as a GUI
or a database. You can also use test events as checkpoints to implement
a resource leak checker, for example.</p>
<p><em>Availability:</em> Linux, Windows, Mac; since v1.4.0.</p>
<h2 id="defining-event-listeners">Defining Event Listeners</h2>
<p>To define a event listener, you subclass either <a
href="../include/gtest/gtest.h#L991">testing::TestEventListener</a> or
<a
href="../include/gtest/gtest.h#L1044">testing::EmptyTestEventListener</a>.
The former is an (abstract) interface, where <i>each pure virtual
method<br> can be overridden to handle a test event</i> (For example,
when a test starts, the <code>OnTestStart()</code> method will be
called.). The latter provides an empty implementation of all methods in
the interface, such that a subclass only needs to override the methods
it cares about.</p>
<p>When an event is fired, its context is passed to the handler function
as an argument. The following argument types are used: * <a
href="../include/gtest/gtest.h#L1151">UnitTest</a> reflects the state of
the entire test program, * <a
href="../include/gtest/gtest.h#L778">TestCase</a> has information about
a test case, which can contain one or more tests, * <a
href="../include/gtest/gtest.h#L644">TestInfo</a> contains the state of
a test, and * <a
href="../include/gtest/gtest-test-part.h#L47">TestPartResult</a>
represents the result of a test assertion.</p>
<p>An event handler function can examine the argument it receives to
find out interesting information about the event and the test program's
state. Here's an example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class MinimalistPrinter : public ::testing::EmptyTestEventListener &#123;</span><br><span class="line">  // Called before a test starts.</span><br><span class="line">  virtual void OnTestStart(const ::testing::TestInfo&amp; test_info) &#123;</span><br><span class="line">    printf(&quot;*** Test %s.%s starting.\n&quot;,</span><br><span class="line">           test_info.test_case_name(), test_info.name());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // Called after a failed assertion or a SUCCEED() invocation.</span><br><span class="line">  virtual void OnTestPartResult(</span><br><span class="line">      const ::testing::TestPartResult&amp; test_part_result) &#123;</span><br><span class="line">    printf(&quot;%s in %s:%d\n%s\n&quot;,</span><br><span class="line">           test_part_result.failed() ? &quot;*** Failure&quot; : &quot;Success&quot;,</span><br><span class="line">           test_part_result.file_name(),</span><br><span class="line">           test_part_result.line_number(),</span><br><span class="line">           test_part_result.summary());</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // Called after a test ends.</span><br><span class="line">  virtual void OnTestEnd(const ::testing::TestInfo&amp; test_info) &#123;</span><br><span class="line">    printf(&quot;*** Test %s.%s ending.\n&quot;,</span><br><span class="line">           test_info.test_case_name(), test_info.name());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="using-event-listeners">Using Event Listeners</h2>
<p>To use the event listener you have defined, add an instance of it to
the Google Test event listener list (represented by class <a
href="../include/gtest/gtest.h#L1064">TestEventListeners</a> - note the
"s" at the end of the name) in your <code>main()</code> function, before
calling <code>RUN_ALL_TESTS()</code>: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char** argv) &#123;</span><br><span class="line">  ::testing::InitGoogleTest(&amp;argc, argv);</span><br><span class="line">  // Gets hold of the event listener list.</span><br><span class="line">  ::testing::TestEventListeners&amp; listeners =</span><br><span class="line">      ::testing::UnitTest::GetInstance()-&gt;listeners();</span><br><span class="line">  // Adds a listener to the end.  Google Test takes the ownership.</span><br><span class="line">  listeners.Append(new MinimalistPrinter);</span><br><span class="line">  return RUN_ALL_TESTS();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>There's only one problem: the default test result printer is still in
effect, so its output will mingle with the output from your minimalist
printer. To suppress the default printer, just release it from the event
listener list and delete it. You can do so by adding one line:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">delete listeners.Release(listeners.default_result_printer());</span><br><span class="line">listeners.Append(new MinimalistPrinter);</span><br><span class="line">return RUN_ALL_TESTS();</span><br></pre></td></tr></table></figure></p>
<p>Now, sit back and enjoy a completely different output from your
tests. For more details, you can read this <a
href="../samples/sample9_unittest.cc">sample</a>.</p>
<p>You may append more than one listener to the list. When an
<code>On*Start()</code> or <code>OnTestPartResult()</code> event is
fired, the listeners will receive it in the order they appear in the
list (since new listeners are added to the end of the list, the default
text printer and the default XML generator will receive the event
first). An <code>On*End()</code> event will be received by the listeners
in the <em>reverse</em> order. This allows output by listeners added
later to be framed by output from listeners added earlier.</p>
<h2 id="generating-failures-in-listeners">Generating Failures in
Listeners</h2>
<p>You may use failure-raising macros (<code>EXPECT_*()</code>,
<code>ASSERT_*()</code>, <code>FAIL()</code>, etc) when processing an
event. There are some restrictions:</p>
<ol type="1">
<li>You cannot generate any failure in <code>OnTestPartResult()</code>
(otherwise it will cause <code>OnTestPartResult()</code> to be called
recursively).</li>
<li>A listener that handles <code>OnTestPartResult()</code> is not
allowed to generate any failure.</li>
</ol>
<p>When you add listeners to the listener list, you should put listeners
that handle <code>OnTestPartResult()</code> <em>before</em> listeners
that can generate failures. This ensures that failures generated by the
latter are attributed to the right test by the former.</p>
<p>We have a sample of failure-raising listener <a
href="../samples/sample10_unittest.cc">here</a>.</p>
<h1 id="running-test-programs-advanced-options">Running Test Programs:
Advanced Options</h1>
<p>Google Test test programs are ordinary executables. Once built, you
can run them directly and affect their behavior via the following
environment variables and/or command line flags. For the flags to work,
your programs must call <code>::testing::InitGoogleTest()</code> before
calling <code>RUN_ALL_TESTS()</code>.</p>
<p>To see a list of supported flags and their usage, please run your
test program with the <code>--help</code> flag. You can also use
<code>-h</code>, <code>-?</code>, or <code>/?</code> for short. This
feature is added in version 1.3.0.</p>
<p>If an option is specified both by an environment variable and by a
flag, the latter takes precedence. Most of the options can also be
set/read in code: to access the value of command line flag
<code>--gtest_foo</code>, write <code>::testing::GTEST_FLAG(foo)</code>.
A common pattern is to set the value of a flag before calling
<code>::testing::InitGoogleTest()</code> to change the default value of
the flag: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char** argv) &#123;</span><br><span class="line">  // Disables elapsed time by default.</span><br><span class="line">  ::testing::GTEST_FLAG(print_time) = false;</span><br><span class="line"></span><br><span class="line">  // This allows the user to override the flag on the command line.</span><br><span class="line">  ::testing::InitGoogleTest(&amp;argc, argv);</span><br><span class="line"></span><br><span class="line">  return RUN_ALL_TESTS();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="selecting-tests">Selecting Tests</h2>
<p>This section shows various options for choosing which tests to
run.</p>
<h3 id="listing-test-names">Listing Test Names</h3>
<p>Sometimes it is necessary to list the available tests in a program
before running them so that a filter may be applied if needed. Including
the flag <code>--gtest_list_tests</code> overrides all other flags and
lists tests in the following format: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TestCase1.</span><br><span class="line">  TestName1</span><br><span class="line">  TestName2</span><br><span class="line">TestCase2.</span><br><span class="line">  TestName</span><br></pre></td></tr></table></figure></p>
<p>None of the tests listed are actually run if the flag is provided.
There is no corresponding environment variable for this flag.</p>
<p><em>Availability:</em> Linux, Windows, Mac.</p>
<h3 id="running-a-subset-of-the-tests">Running a Subset of the
Tests</h3>
<p>By default, a Google Test program runs all tests the user has
defined. Sometimes, you want to run only a subset of the tests (e.g. for
debugging or quickly verifying a change). If you set the
<code>GTEST_FILTER</code> environment variable or the
<code>--gtest_filter</code> flag to a filter string, Google Test will
only run the tests whose full names (in the form of
<code>TestCaseName.TestName</code>) match the filter.</p>
<p>The format of a filter is a '<code>:</code>'-separated list of
wildcard patterns (called the positive patterns) optionally followed by
a '<code>-</code>' and another '<code>:</code>'-separated pattern list
(called the negative patterns). A test matches the filter if and only if
it matches any of the positive patterns but does not match any of the
negative patterns.</p>
<p>A pattern may contain <code>'*'</code> (matches any string) or
<code>'?'</code> (matches any single character). For convenience, the
filter <code>'*-NegativePatterns'</code> can be also written as
<code>'-NegativePatterns'</code>.</p>
<p>For example:</p>
<ul>
<li><code>./foo_test</code> Has no flag, and thus runs all its
tests.</li>
<li><code>./foo_test --gtest_filter=*</code> Also runs everything, due
to the single match-everything <code>*</code> value.</li>
<li><code>./foo_test --gtest_filter=FooTest.*</code> Runs everything in
test case <code>FooTest</code>.</li>
<li><code>./foo_test --gtest_filter=*Null*:*Constructor*</code> Runs any
test whose full name contains either <code>"Null"</code> or
<code>"Constructor"</code>.</li>
<li><code>./foo_test --gtest_filter=-*DeathTest.*</code> Runs all
non-death tests.</li>
<li><code>./foo_test --gtest_filter=FooTest.*-FooTest.Bar</code> Runs
everything in test case <code>FooTest</code> except
<code>FooTest.Bar</code>.</li>
</ul>
<p><em>Availability:</em> Linux, Windows, Mac.</p>
<h3 id="temporarily-disabling-tests">Temporarily Disabling Tests</h3>
<p>If you have a broken test that you cannot fix right away, you can add
the <code>DISABLED_</code> prefix to its name. This will exclude it from
execution. This is better than commenting out the code or using
<code>#if 0</code>, as disabled tests are still compiled (and thus won't
rot).</p>
<p>If you need to disable all tests in a test case, you can either add
<code>DISABLED_</code> to the front of the name of each test, or
alternatively add it to the front of the test case name.</p>
<p>For example, the following tests won't be run by Google Test, even
though they will still be compiled:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// Tests that Foo does Abc.</span><br><span class="line">TEST(FooTest, DISABLED_DoesAbc) &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">class DISABLED_BarTest : public ::testing::Test &#123; ... &#125;;</span><br><span class="line"></span><br><span class="line">// Tests that Bar does Xyz.</span><br><span class="line">TEST_F(DISABLED_BarTest, DoesXyz) &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p><em>Note:</em> This feature should only be used for temporary
pain-relief. You still have to fix the disabled tests at a later date.
As a reminder, Google Test will print a banner warning you if a test
program contains any disabled tests.</p>
<p><em>Tip:</em> You can easily count the number of disabled tests you
have using <code>grep</code>. This number can be used as a metric for
improving your test quality.</p>
<p><em>Availability:</em> Linux, Windows, Mac.</p>
<h3 id="temporarily-enabling-disabled-tests">Temporarily Enabling
Disabled Tests</h3>
<p>To include <a href="#temporarily-disabling-tests">disabled tests</a>
in test execution, just invoke the test program with the
<code>--gtest_also_run_disabled_tests</code> flag or set the
<code>GTEST_ALSO_RUN_DISABLED_TESTS</code> environment variable to a
value other than <code>0</code>. You can combine this with the <a
href="#running-a-subset-of-the-tests">--gtest_filter</a> flag to further
select which disabled tests to run.</p>
<p><em>Availability:</em> Linux, Windows, Mac; since version 1.3.0.</p>
<h2 id="repeating-the-tests">Repeating the Tests</h2>
<p>Once in a while you'll run into a test whose result is hit-or-miss.
Perhaps it will fail only 1% of the time, making it rather hard to
reproduce the bug under a debugger. This can be a major source of
frustration.</p>
<p>The <code>--gtest_repeat</code> flag allows you to repeat all (or
selected) test methods in a program many times. Hopefully, a flaky test
will eventually fail and give you a chance to debug. Here's how to use
it:</p>
<table>
<colgroup>
<col style="width: 37%" />
<col style="width: 62%" />
</colgroup>
<thead>
<tr class="header">
<th
style="text-align: left;"><code>$ foo_test --gtest_repeat=1000</code></th>
<th style="text-align: left;">Repeat foo_test 1000 times and don't stop
at failures.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td
style="text-align: left;"><code>$ foo_test --gtest_repeat=-1</code></td>
<td style="text-align: left;">A negative count means repeating
forever.</td>
</tr>
<tr class="even">
<td
style="text-align: left;"><code>$ foo_test --gtest_repeat=1000 --gtest_break_on_failure</code></td>
<td style="text-align: left;">Repeat foo_test 1000 times, stopping at
the first failure. This is especially useful when running under a
debugger: when the testfails, it will drop into the debugger and you can
then inspect variables and stacks.</td>
</tr>
<tr class="odd">
<td
style="text-align: left;"><code>$ foo_test --gtest_repeat=1000 --gtest_filter=FooBar</code></td>
<td style="text-align: left;">Repeat the tests whose name matches the
filter 1000 times.</td>
</tr>
</tbody>
</table>
<p>If your test program contains global set-up/tear-down code registered
using <code>AddGlobalTestEnvironment()</code>, it will be repeated in
each iteration as well, as the flakiness may be in it. You can also
specify the repeat count by setting the <code>GTEST_REPEAT</code>
environment variable.</p>
<p><em>Availability:</em> Linux, Windows, Mac.</p>
<h2 id="shuffling-the-tests">Shuffling the Tests</h2>
<p>You can specify the <code>--gtest_shuffle</code> flag (or set the
<code>GTEST_SHUFFLE</code> environment variable to <code>1</code>) to
run the tests in a program in a random order. This helps to reveal bad
dependencies between tests.</p>
<p>By default, Google Test uses a random seed calculated from the
current time. Therefore you'll get a different order every time. The
console output includes the random seed value, such that you can
reproduce an order-related test failure later. To specify the random
seed explicitly, use the <code>--gtest_random_seed=SEED</code> flag (or
set the <code>GTEST_RANDOM_SEED</code> environment variable), where
<code>SEED</code> is an integer between 0 and 99999. The seed value 0 is
special: it tells Google Test to do the default behavior of calculating
the seed from the current time.</p>
<p>If you combine this with <code>--gtest_repeat=N</code>, Google Test
will pick a different random seed and re-shuffle the tests in each
iteration.</p>
<p><em>Availability:</em> Linux, Windows, Mac; since v1.4.0.</p>
<h2 id="controlling-test-output">Controlling Test Output</h2>
<p>This section teaches how to tweak the way test results are
reported.</p>
<h3 id="colored-terminal-output">Colored Terminal Output</h3>
<p>Google Test can use colors in its terminal output to make it easier
to spot the separation between tests, and whether tests passed.</p>
<p>You can set the GTEST_COLOR environment variable or set the
<code>--gtest_color</code> command line flag to <code>yes</code>,
<code>no</code>, or <code>auto</code> (the default) to enable colors,
disable colors, or let Google Test decide. When the value is
<code>auto</code>, Google Test will use colors if and only if the output
goes to a terminal and (on non-Windows platforms) the <code>TERM</code>
environment variable is set to <code>xterm</code> or
<code>xterm-color</code>.</p>
<p><em>Availability:</em> Linux, Windows, Mac.</p>
<h3 id="suppressing-the-elapsed-time">Suppressing the Elapsed Time</h3>
<p>By default, Google Test prints the time it takes to run each test. To
suppress that, run the test program with the
<code>--gtest_print_time=0</code> command line flag. Setting the
<code>GTEST_PRINT_TIME</code> environment variable to <code>0</code> has
the same effect.</p>
<p><em>Availability:</em> Linux, Windows, Mac. (In Google Test 1.3.0 and
lower, the default behavior is that the elapsed time is
<strong>not</strong> printed.)</p>
<h3 id="generating-an-xml-report">Generating an XML Report</h3>
<p>Google Test can emit a detailed XML report to a file in addition to
its normal textual output. The report contains the duration of each
test, and thus can help you identify slow tests.</p>
<p>To generate the XML report, set the <code>GTEST_OUTPUT</code>
environment variable or the <code>--gtest_output</code> flag to the
string <code>"xml:_path_to_output_file_"</code>, which will create the
file at the given location. You can also just use the string
<code>"xml"</code>, in which case the output can be found in the
<code>test_detail.xml</code> file in the current directory.</p>
<p>If you specify a directory (for example,
<code>"xml:output/directory/"</code> on Linux or
<code>"xml:output\directory\"</code> on Windows), Google Test will
create the XML file in that directory, named after the test executable
(e.g. <code>foo_test.xml</code> for test program <code>foo_test</code>
or <code>foo_test.exe</code>). If the file already exists (perhaps left
over from a previous run), Google Test will pick a different name (e.g.
<code>foo_test_1.xml</code>) to avoid overwriting it.</p>
<p>The report uses the format described here. It is based on the
<code>junitreport</code> Ant task and can be parsed by popular
continuous build systems like <a
target="_blank" rel="noopener" href="https://hudson.dev.java.net/">Hudson</a>. Since that format was
originally intended for Java, a little interpretation is required to
make it apply to Google Test tests, as shown here:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;testsuites name=&quot;AllTests&quot; ...&gt;</span><br><span class="line">  &lt;testsuite name=&quot;test_case_name&quot; ...&gt;</span><br><span class="line">    &lt;testcase name=&quot;test_name&quot; ...&gt;</span><br><span class="line">      &lt;failure message=&quot;...&quot;/&gt;</span><br><span class="line">      &lt;failure message=&quot;...&quot;/&gt;</span><br><span class="line">      &lt;failure message=&quot;...&quot;/&gt;</span><br><span class="line">    &lt;/testcase&gt;</span><br><span class="line">  &lt;/testsuite&gt;</span><br><span class="line">&lt;/testsuites&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>The root <code>&lt;testsuites&gt;</code> element corresponds to the
entire test program.</li>
<li><code>&lt;testsuite&gt;</code> elements correspond to Google Test
test cases.</li>
<li><code>&lt;testcase&gt;</code> elements correspond to Google Test
test functions.</li>
</ul>
<p>For instance, the following program</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEST(MathTest, Addition) &#123; ... &#125;</span><br><span class="line">TEST(MathTest, Subtraction) &#123; ... &#125;</span><br><span class="line">TEST(LogicTest, NonContradiction) &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>could generate this report:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;testsuites tests=&quot;3&quot; failures=&quot;1&quot; errors=&quot;0&quot; time=&quot;35&quot; name=&quot;AllTests&quot;&gt;</span><br><span class="line">  &lt;testsuite name=&quot;MathTest&quot; tests=&quot;2&quot; failures=&quot;1&quot; errors=&quot;0&quot; time=&quot;15&quot;&gt;</span><br><span class="line">    &lt;testcase name=&quot;Addition&quot; status=&quot;run&quot; time=&quot;7&quot; classname=&quot;&quot;&gt;</span><br><span class="line">      &lt;failure message=&quot;Value of: add(1, 1)&amp;#x0A; Actual: 3&amp;#x0A;Expected: 2&quot; type=&quot;&quot;/&gt;</span><br><span class="line">      &lt;failure message=&quot;Value of: add(1, -1)&amp;#x0A; Actual: 1&amp;#x0A;Expected: 0&quot; type=&quot;&quot;/&gt;</span><br><span class="line">    &lt;/testcase&gt;</span><br><span class="line">    &lt;testcase name=&quot;Subtraction&quot; status=&quot;run&quot; time=&quot;5&quot; classname=&quot;&quot;&gt;</span><br><span class="line">    &lt;/testcase&gt;</span><br><span class="line">  &lt;/testsuite&gt;</span><br><span class="line">  &lt;testsuite name=&quot;LogicTest&quot; tests=&quot;1&quot; failures=&quot;0&quot; errors=&quot;0&quot; time=&quot;5&quot;&gt;</span><br><span class="line">    &lt;testcase name=&quot;NonContradiction&quot; status=&quot;run&quot; time=&quot;5&quot; classname=&quot;&quot;&gt;</span><br><span class="line">    &lt;/testcase&gt;</span><br><span class="line">  &lt;/testsuite&gt;</span><br><span class="line">&lt;/testsuites&gt;</span><br></pre></td></tr></table></figure>
<p>Things to note:</p>
<ul>
<li>The <code>tests</code> attribute of a
<code>&lt;testsuites&gt;</code> or <code>&lt;testsuite&gt;</code>
element tells how many test functions the Google Test program or test
case contains, while the <code>failures</code> attribute tells how many
of them failed.</li>
<li>The <code>time</code> attribute expresses the duration of the test,
test case, or entire test program in milliseconds.</li>
<li>Each <code>&lt;failure&gt;</code> element corresponds to a single
failed Google Test assertion.</li>
<li>Some JUnit concepts don't apply to Google Test, yet we have to
conform to the DTD. Therefore you'll see some dummy elements and
attributes in the report. You can safely ignore these parts.</li>
</ul>
<p><em>Availability:</em> Linux, Windows, Mac.</p>
<h2 id="controlling-how-failures-are-reported">Controlling How Failures
Are Reported</h2>
<h3 id="turning-assertion-failures-into-break-points">Turning Assertion
Failures into Break-Points</h3>
<p>When running test programs under a debugger, it's very convenient if
the debugger can catch an assertion failure and automatically drop into
interactive mode. Google Test's <em>break-on-failure</em> mode supports
this behavior.</p>
<p>To enable it, set the <code>GTEST_BREAK_ON_FAILURE</code> environment
variable to a value other than <code>0</code> . Alternatively, you can
use the <code>--gtest_break_on_failure</code> command line flag.</p>
<p><em>Availability:</em> Linux, Windows, Mac.</p>
<h3 id="disabling-catching-test-thrown-exceptions">Disabling Catching
Test-Thrown Exceptions</h3>
<p>Google Test can be used either with or without exceptions enabled. If
a test throws a C++ exception or (on Windows) a structured exception
(SEH), by default Google Test catches it, reports it as a test failure,
and continues with the next test method. This maximizes the coverage of
a test run. Also, on Windows an uncaught exception will cause a pop-up
window, so catching the exceptions allows you to run the tests
automatically.</p>
<p>When debugging the test failures, however, you may instead want the
exceptions to be handled by the debugger, such that you can examine the
call stack when an exception is thrown. To achieve that, set the
<code>GTEST_CATCH_EXCEPTIONS</code> environment variable to
<code>0</code>, or use the <code>--gtest_catch_exceptions=0</code> flag
when running the tests.</p>
<p><strong>Availability</strong>: Linux, Windows, Mac.</p>
<h3 id="letting-another-testing-framework-drive">Letting Another Testing
Framework Drive</h3>
<p>If you work on a project that has already been using another testing
framework and is not ready to completely switch to Google Test yet, you
can get much of Google Test's benefit by using its assertions in your
existing tests. Just change your <code>main()</code> function to look
like:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;gtest/gtest.h&quot;</span><br><span class="line"></span><br><span class="line">int main(int argc, char** argv) &#123;</span><br><span class="line">  ::testing::GTEST_FLAG(throw_on_failure) = true;</span><br><span class="line">  // Important: Google Test must be initialized.</span><br><span class="line">  ::testing::InitGoogleTest(&amp;argc, argv);</span><br><span class="line"></span><br><span class="line">  ... whatever your existing testing framework requires ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With that, you can use Google Test assertions in addition to the
native assertions your testing framework provides, for example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void TestFooDoesBar() &#123;</span><br><span class="line">  Foo foo;</span><br><span class="line">  EXPECT_LE(foo.Bar(1), 100);     // A Google Test assertion.</span><br><span class="line">  CPPUNIT_ASSERT(foo.IsEmpty());  // A native assertion.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If a Google Test assertion fails, it will print an error message and
throw an exception, which will be treated as a failure by your host
testing framework. If you compile your code with exceptions disabled, a
failed Google Test assertion will instead exit your program with a
non-zero code, which will also signal a test failure to your test
runner.</p>
<p>If you don't write
<code>::testing::GTEST_FLAG(throw_on_failure) = true;</code> in your
<code>main()</code>, you can alternatively enable this feature by
specifying the <code>--gtest_throw_on_failure</code> flag on the
command-line or setting the <code>GTEST_THROW_ON_FAILURE</code>
environment variable to a non-zero value.</p>
<p>Death tests are <em>not</em> supported when other test framework is
used to organize tests.</p>
<p><em>Availability:</em> Linux, Windows, Mac; since v1.3.0.</p>
<h2 id="distributing-test-functions-to-multiple-machines">Distributing
Test Functions to Multiple Machines</h2>
<p>If you have more than one machine you can use to run a test program,
you might want to run the test functions in parallel and get the result
faster. We call this technique <em>sharding</em>, where each machine is
called a <em>shard</em>.</p>
<p>Google Test is compatible with test sharding. To take advantage of
this feature, your test runner (not part of Google Test) needs to do the
following:</p>
<ol type="1">
<li>Allocate a number of machines (shards) to run the tests.</li>
<li>On each shard, set the <code>GTEST_TOTAL_SHARDS</code> environment
variable to the total number of shards. It must be the same for all
shards.</li>
<li>On each shard, set the <code>GTEST_SHARD_INDEX</code> environment
variable to the index of the shard. Different shards must be assigned
different indices, which must be in the range
<code>[0, GTEST_TOTAL_SHARDS - 1]</code>.</li>
<li>Run the same test program on all shards. When Google Test sees the
above two environment variables, it will select a subset of the test
functions to run. Across all shards, each test function in the program
will be run exactly once.</li>
<li>Wait for all shards to finish, then collect and report the
results.</li>
</ol>
<p>Your project may have tests that were written without Google Test and
thus don't understand this protocol. In order for your test runner to
figure out which test supports sharding, it can set the environment
variable <code>GTEST_SHARD_STATUS_FILE</code> to a non-existent file
path. If a test program supports sharding, it will create this file to
acknowledge the fact (the actual contents of the file are not important
at this time; although we may stick some useful information in it in the
future.); otherwise it will not create it.</p>
<p>Here's an example to make it clear. Suppose you have a test program
<code>foo_test</code> that contains the following 5 test functions:
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TEST(A, V)</span><br><span class="line">TEST(A, W)</span><br><span class="line">TEST(B, X)</span><br><span class="line">TEST(B, Y)</span><br><span class="line">TEST(B, Z)</span><br></pre></td></tr></table></figure> and you have 3 machines at your disposal. To run the
test functions in parallel, you would set
<code>GTEST_TOTAL_SHARDS</code> to 3 on all machines, and set
<code>GTEST_SHARD_INDEX</code> to 0, 1, and 2 on the machines
respectively. Then you would run the same <code>foo_test</code> on each
machine.</p>
<p>Google Test reserves the right to change how the work is distributed
across the shards, but here's one possible scenario:</p>
<ul>
<li>Machine #0 runs <code>A.V</code> and <code>B.X</code>.</li>
<li>Machine #1 runs <code>A.W</code> and <code>B.Y</code>.</li>
<li>Machine #2 runs <code>B.Z</code>.</li>
</ul>
<p><em>Availability:</em> Linux, Windows, Mac; since version 1.3.0.</p>
<h1 id="fusing-google-test-source-files">Fusing Google Test Source
Files</h1>
<p>Google Test's implementation consists of ~30 files (excluding its own
tests). Sometimes you may want them to be packaged up in two files (a
<code>.h</code> and a <code>.cc</code>) instead, such that you can
easily copy them to a new machine and start hacking there. For this we
provide an experimental Python script <code>fuse_gtest_files.py</code>
in the <code>scripts/</code> directory (since release 1.3.0). Assuming
you have Python 2.4 or above installed on your machine, just go to that
directory and run <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python fuse_gtest_files.py OUTPUT_DIR</span><br></pre></td></tr></table></figure></p>
<p>and you should see an <code>OUTPUT_DIR</code> directory being created
with files <code>gtest/gtest.h</code> and
<code>gtest/gtest-all.cc</code> in it. These files contain everything
you need to use Google Test. Just copy them to anywhere you want and you
are ready to write tests. You can use the <a
href="../scripts/test/Makefile">scripts/test/Makefile</a> file as an
example on how to compile your tests against them.</p>
<h1 id="where-to-go-from-here-1">Where to Go from Here</h1>
<p>Congratulations! You've now learned more advanced Google Test tools
and are ready to tackle more complex testing tasks. If you want to dive
even deeper, you can read the <a href="FAQ.md">Frequently-Asked
Questions</a>.</p>

    </div>

    
    
    
      


    <footer class="post-footer"><div class="post-widgets">
    <div
      class="social-share"
      
        data-sites="weibo,qq,wechat,tencent,douban,qzone,linkedin,diandian,facebook,twitter,google"
      
      
        data-wechat-qrcode-title="share.title"
      
      
        data-wechat-qrcode-helper="share.prompt"
      
    >
    </div>
  </div>
  <script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js"></script>
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>CharlesCao
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://www.deepindeed.cn/201811/20181111-hight-property-codes/" title="《高质量的C++代码笔记》">http://www.deepindeed.cn/201811/20181111-hight-property-codes/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C++</a>
              <a href="/tags/%E5%BC%80%E5%8F%91/" rel="tag"># 开发</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/201805/20180506-std-license-list/" rel="prev" title="开发：开源协议">
                  <i class="fa fa-chevron-left"></i> 开发：开源协议
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/201811/20181128-gnu-cpp-programming-tricks/" rel="next" title="C++ Programming Tricks">
                  C++ Programming Tricks <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CharlesCao</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">450k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">12:30</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@9.0.1/dist/mermaid.min.js","integrity":"sha256-CemUs9ITT7liCZpVMktcEw0BpAOZ1+mujlMB3UyuImU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>



  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-CN","enable":true,"serverURL":"https://waline.vercel.app","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"libUrl":"https://unpkg.com/@waline/client@v2/dist/waline.js","locale":{"placeholder":"欢迎交流指正"},"emoji":["https://unpkg.com/@waline/emojis@1.0.1/weibo","https://unpkg.com/@waline/emojis@1.0.1/alus","https://unpkg.com/@waline/emojis@1.0.1/bilibili","https://unpkg.com/@waline/emojis@1.0.1/qq","https://unpkg.com/@waline/emojis@1.0.1/tieba","https://unpkg.com/@waline/emojis@1.0.1/tw-emoji"],"meta":["nick","mail"],"requiredMeta":["mail","nick","mail"],"login":"enable","el":"#waline","comment":true,"path":"/201811/20181111-hight-property-codes/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
